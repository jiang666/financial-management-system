# 组织架构后端接口分析文档

## 1. 概述

本文档基于前端组织架构功能需求，结合后端开发技术约束文档（V2.0）和数据库表结构设计，详细定义组织架构模块所需的后端接口。

## 2. 技术约束要求

- 使用Spring Boot + Spring Data JPA
- 所有ID字段使用UUID生成
- 时间字段使用Long类型毫秒时间戳
- 统一响应格式使用ResponseEntity和ResponsePageDataEntity
- 禁用JPA关系注解，外键作为普通字段处理
- 必含字段：id, createTime, updateTime, createBy, updateBy

## 3. 数据库表设计（基于departments表）

```sql
CREATE TABLE departments (
    id VARCHAR(36) PRIMARY KEY COMMENT '部门ID',
    code VARCHAR(50) NOT NULL UNIQUE COMMENT '部门编码',
    name VARCHAR(100) NOT NULL COMMENT '部门名称',
    parent_id VARCHAR(36) COMMENT '上级部门ID',
    level INT NOT NULL DEFAULT 1 COMMENT '层级',
    path VARCHAR(500) COMMENT '层级路径',
    manager_id VARCHAR(36) COMMENT '部门负责人ID',
    contact_phone VARCHAR(20) COMMENT '联系电话',
    description TEXT COMMENT '部门描述',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态: 1-启用 0-禁用',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at BIGINT NOT NULL COMMENT '创建时间',
    updated_at BIGINT NOT NULL COMMENT '更新时间',
    created_by VARCHAR(36) COMMENT '创建人',
    updated_by VARCHAR(36) COMMENT '更新人',
    deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除'
);
```

## 4. 后端接口定义

### 4.1 部门管理接口

#### 4.1.1 获取组织架构树
- **URL**: `/api/departments/tree`
- **Method**: GET
- **权限**: 需要登录
- **请求参数**: 无
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "uuid-xxx",
      "code": "DEPT001",
      "name": "总公司",
      "type": "公司",  // 公司/部门/小组
      "parentId": null,
      "managerId": "user-uuid",
      "manager": "张总",  // 负责人姓名
      "phone": "13800000000",
      "employeeCount": 500,  // 员工数量
      "status": "启用",
      "description": "公司总部",
      "children": [
        {
          "id": "uuid-yyy",
          "code": "DEPT002",
          "name": "财务部",
          "type": "部门",
          "parentId": "uuid-xxx",
          "managerId": "user-uuid2",
          "manager": "李主任",
          "phone": "13800000001",
          "employeeCount": 20,
          "status": "启用",
          "description": "负责财务管理",
          "children": []
        }
      ]
    }
  ]
}
```

#### 4.1.2 创建部门
- **URL**: `/api/departments`
- **Method**: POST
- **权限**: 需要ORGANIZATION资源权限
- **请求参数**:
```json
{
  "name": "市场部",
  "code": "DEPT003",  // 可选，不传则自动生成
  "type": "部门",  // 公司/部门/小组
  "parentId": "uuid-xxx",  // 可选，不传则为根部门
  "managerId": "user-uuid",  // 负责人ID
  "phone": "13800000002",
  "description": "负责市场营销"
}
```
- **响应参数**:
```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "id": "uuid-zzz",
    "code": "DEPT003",
    "name": "市场部",
    "createTime": 1703123456789,
    "updateTime": 1703123456789,
    "createBy": "admin",
    "updateBy": "admin"
  }
}
```

#### 4.1.3 更新部门信息
- **URL**: `/api/departments/{id}`
- **Method**: PUT
- **权限**: 需要ORGANIZATION资源权限
- **请求参数**:
```json
{
  "name": "市场营销部",
  "type": "部门",
  "parentId": "uuid-xxx",
  "managerId": "user-uuid",
  "phone": "13800000003",
  "status": "启用",
  "description": "负责市场营销和推广"
}
```
- **响应参数**:
```json
{
  "code": 200,
  "message": "更新成功",
  "data": null
}
```

#### 4.1.4 删除部门
- **URL**: `/api/departments/{id}`
- **Method**: DELETE
- **权限**: 需要ORGANIZATION资源权限
- **业务规则**: 
  - 如有子部门，需要级联删除或阻止删除
  - 如有员工关联，需要处理员工归属问题
- **响应参数**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null
}
```

#### 4.1.5 获取部门详情
- **URL**: `/api/departments/{id}`
- **Method**: GET
- **权限**: 需要登录
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": "uuid-xxx",
    "code": "DEPT001",
    "name": "总公司",
    "type": "公司",
    "parentId": null,
    "parentName": null,
    "managerId": "user-uuid",
    "manager": "张总",
    "phone": "13800000000",
    "employeeCount": 500,
    "status": "启用",
    "description": "公司总部",
    "level": 1,
    "path": "/uuid-xxx",
    "createTime": 1703123456789,
    "updateTime": 1703123456789,
    "createBy": "system",
    "updateBy": "admin"
  }
}
```

### 4.2 岗位管理接口

#### 4.2.1 获取部门岗位列表
- **URL**: `/api/departments/{departmentId}/positions`
- **Method**: GET
- **权限**: 需要登录
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "pos-uuid-1",
      "departmentId": "uuid-xxx",
      "name": "部门经理",
      "level": "高级",  // 高级/中级/初级
      "count": 1,  // 编制人数
      "actualCount": 1,  // 实际人数
      "salary": 15000.00,  // 基础薪资
      "status": "启用",
      "description": "负责部门整体管理",
      "createTime": 1703123456789,
      "updateTime": 1703123456789
    }
  ]
}
```

#### 4.2.2 创建岗位
- **URL**: `/api/positions`
- **Method**: POST
- **权限**: 需要ORGANIZATION资源权限
- **请求参数**:
```json
{
  "departmentId": "uuid-xxx",
  "name": "高级经理",
  "level": "高级",
  "count": 2,
  "salary": 20000.00,
  "description": "负责重要项目管理"
}
```

#### 4.2.3 更新岗位
- **URL**: `/api/positions/{id}`
- **Method**: PUT
- **权限**: 需要ORGANIZATION资源权限
- **请求参数**:
```json
{
  "name": "高级项目经理",
  "level": "高级",
  "count": 3,
  "salary": 25000.00,
  "status": "启用",
  "description": "负责重要项目管理和团队建设"
}
```

#### 4.2.4 删除岗位
- **URL**: `/api/positions/{id}`
- **Method**: DELETE
- **权限**: 需要ORGANIZATION资源权限
- **业务规则**: 如有员工占用该岗位，需要先处理员工岗位调整

### 4.3 员工分配接口

#### 4.3.1 获取部门员工列表
- **URL**: `/api/departments/{departmentId}/employees`
- **Method**: GET
- **权限**: 需要登录
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": "user-uuid-1",
      "name": "张三",
      "realName": "张三",
      "employeeId": "EMP001",
      "departmentId": "uuid-xxx",
      "departmentName": "财务部",
      "positionId": "pos-uuid-1",
      "position": "部门经理",
      "phone": "13800138001",
      "email": "zhang@example.com",
      "hireDate": "2023-01-15",
      "status": "在职"  // 在职/离职/休假
    }
  ]
}
```

#### 4.3.2 分配员工到部门
- **URL**: `/api/department-employees`
- **Method**: POST
- **权限**: 需要ORGANIZATION资源权限
- **请求参数**:
```json
{
  "userId": "user-uuid",
  "departmentId": "dept-uuid",
  "positionId": "pos-uuid"
}
```

#### 4.3.3 员工部门调动
- **URL**: `/api/department-employees/transfer`
- **Method**: POST
- **权限**: 需要ORGANIZATION资源权限
- **请求参数**:
```json
{
  "userId": "user-uuid",
  "fromDepartmentId": "dept-uuid-1",
  "toDepartmentId": "dept-uuid-2",
  "positionId": "pos-uuid",
  "transferDate": 1703123456789,
  "reason": "工作需要"
}
```

### 4.4 统计查询接口

#### 4.4.1 获取部门统计信息
- **URL**: `/api/departments/{id}/statistics`
- **Method**: GET
- **权限**: 需要登录
- **响应参数**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "departmentId": "uuid-xxx",
    "departmentName": "财务部",
    "totalEmployees": 20,
    "positionCount": 5,
    "subDepartmentCount": 3,
    "totalSalaryBudget": 300000.00,
    "actualSalaryCost": 280000.00,
    "employeesByPosition": [
      {
        "positionName": "部门经理",
        "count": 1
      },
      {
        "positionName": "会计",
        "count": 5
      }
    ]
  }
}
```

## 5. 实体类设计示例

### 5.1 Department实体
```java
@Entity
@Table(name = "departments")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Department {
    @Id
    @Column(name = "id")
    private String id;
    
    @Column(name = "code")
    private String code;
    
    @Column(name = "name")
    private String name;
    
    @Column(name = "parent_id")
    private String parentId;
    
    @Column(name = "level")
    private Integer level;
    
    @Column(name = "path")
    private String path;
    
    @Column(name = "manager_id")
    private String managerId;
    
    @Column(name = "contact_phone")
    private String contactPhone;
    
    @Column(name = "description")
    private String description;
    
    @Column(name = "status")
    private Integer status;
    
    @Column(name = "sort_order")
    private Integer sortOrder;
    
    @Column(name = "created_at")
    private Long createdAt;
    
    @Column(name = "updated_at")
    private Long updatedAt;
    
    @Column(name = "created_by")
    private String createdBy;
    
    @Column(name = "updated_by")
    private String updatedBy;
    
    @Column(name = "deleted")
    private Integer deleted;
}
```

## 6. DTO设计示例

### 6.1 DepartmentTreeDTO
```java
@Data
public class DepartmentTreeDTO {
    private String id;
    private String code;
    private String name;
    private String type;
    private String parentId;
    private String managerId;
    private String manager;
    private String phone;
    private Integer employeeCount;
    private String status;
    private String description;
    private List<DepartmentTreeDTO> children;
}
```

### 6.2 CreateDepartmentDTO
```java
@Data
public class CreateDepartmentDTO {
    @NotBlank(message = "部门名称不能为空")
    private String name;
    
    private String code;
    
    @NotBlank(message = "部门类型不能为空")
    private String type;
    
    private String parentId;
    
    private String managerId;
    
    private String phone;
    
    private String description;
}
```

## 7. 接口权限控制

基于Spring Security和资源权限表(tb_resource)：

- 所有接口需要用户登录认证
- 组织架构管理(ORGANIZATION)资源权限控制增删改操作
- 查询接口对所有登录用户开放
- 通过@PreAuthorize注解实现方法级权限控制

## 8. 注意事项

1. **级联操作**：删除部门时需要处理子部门和员工归属
2. **数据一致性**：更新部门层级时需要更新path和level字段
3. **员工统计**：employeeCount需要实时计算或定期更新
4. **编码生成**：部门编码可以自动生成，格式如DEPT+序号
5. **状态转换**：前端使用中文状态，后端存储使用数字(1/0)
6. **外键处理**：根据技术约束，不使用JPA外键关联，通过Service层处理关联查询

## 9. 错误处理

统一错误响应格式：
```json
{
  "code": 400,
  "message": "部门名称已存在",
  "data": null
}
```

常见错误码：
- 400: 请求参数错误
- 401: 未授权
- 403: 无权限
- 404: 资源不存在
- 500: 服务器内部错误