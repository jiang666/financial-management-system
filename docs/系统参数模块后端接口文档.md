# 系统参数模块后端接口文档

## 1. 概述

本文档定义了财务管理系统中系统参数模块的所有后端接口，包括请求参数、返回参数、错误码等详细信息。

### 1.1 基础信息
- **模块路径**: `/api/v1/system/parameters`
- **认证方式**: Bearer Token
- **返回格式**: JSON
- **字符编码**: UTF-8

### 1.2 通用响应格式

```java
{
    "code": 200,          // 响应码：200成功，其他为错误
    "message": "操作成功", // 响应消息
    "data": {},           // 响应数据
    "timestamp": 1234567890000  // 时间戳
}
```

## 2. 数据模型

### 2.1 系统参数实体 (SystemParameter)

| 字段名 | 类型 | 说明 | 必填 |
|--------|------|------|------|
| id | String | 参数ID (UUID) | 是 |
| paramKey | String | 参数键 | 是 |
| paramValue | String | 参数值 | 否 |
| paramType | String | 参数类型 | 是 |
| category | String | 参数分类 | 否 |
| description | String | 参数描述 | 否 |
| isSystem | Boolean | 是否系统参数 | 是 |
| isEncrypted | Boolean | 是否加密 | 是 |
| sortOrder | Integer | 排序 | 否 |
| validationRule | String | 验证规则 | 否 |
| minValue | String | 最小值 | 否 |
| maxValue | String | 最大值 | 否 |
| options | String | 可选值列表(JSON) | 否 |
| defaultValue | String | 默认值 | 否 |
| required | Boolean | 是否必填 | 是 |
| visible | Boolean | 是否可见 | 是 |
| editable | Boolean | 是否可编辑 | 是 |
| effectiveImmediately | Boolean | 是否立即生效 | 是 |
| restartRequired | Boolean | 是否需要重启 | 是 |
| createdAt | Long | 创建时间 | 是 |
| updatedAt | Long | 更新时间 | 是 |
| createdBy | String | 创建人 | 否 |
| updatedBy | String | 更新人 | 否 |

### 2.2 参数类型枚举 (ParamType)

```java
public enum ParamType {
    STRING,    // 字符串
    INTEGER,   // 整数
    DECIMAL,   // 小数
    BOOLEAN,   // 布尔值
    JSON,      // JSON对象
    DATE,      // 日期
    DATETIME,  // 日期时间
    TIME,      // 时间
    ENUM       // 枚举
}
```

### 2.3 参数分类枚举 (ParamCategory)

```java
public enum ParamCategory {
    BASIC,              // 基础设置
    FINANCIAL,          // 财务核算
    CUSTOMER_SUPPLIER,  // 往来管理
    REPORT,             // 报表参数
    SYSTEM,             // 系统管理
    INTEGRATION         // 接口集成
}
```

## 3. DTO定义

### 3.1 系统参数DTO (SystemParameterDTO)

```java
@Data
public class SystemParameterDTO {
    private String id;
    private String paramKey;
    private String paramValue;
    private String paramType;
    private String category;
    private String description;
    private Boolean isSystem;
    private Boolean isEncrypted;
    private Integer sortOrder;
    private String validationRule;
    private String minValue;
    private String maxValue;
    private String options;
    private String defaultValue;
    private Boolean required;
    private Boolean visible;
    private Boolean editable;
    private Boolean effectiveImmediately;
    private Boolean restartRequired;
    private Long createdAt;
    private Long updatedAt;
    private String createdBy;
    private String updatedBy;
}
```

### 3.2 系统参数查询DTO (SystemParameterQueryDTO)

```java
@Data
public class SystemParameterQueryDTO {
    private String category;      // 参数分类
    private String keyword;       // 关键字搜索
    private Boolean isSystem;     // 是否系统参数
    private Boolean visible;      // 是否可见
    private Integer page = 0;     // 页码
    private Integer size = 20;    // 每页大小
}
```

### 3.3 系统参数更新DTO (SystemParameterUpdateDTO)

```java
@Data
public class SystemParameterUpdateDTO {
    @NotBlank(message = "参数值不能为空")
    private String paramValue;
    
    private String description;
    private String validationRule;
    private String minValue;
    private String maxValue;
    private String options;
    private String defaultValue;
    private Boolean required;
    private Boolean visible;
    private Boolean editable;
    private Boolean effectiveImmediately;
    private Boolean restartRequired;
}
```

### 3.4 系统参数批量更新DTO (SystemParameterBatchUpdateDTO)

```java
@Data
public class SystemParameterBatchUpdateDTO {
    @NotEmpty(message = "参数列表不能为空")
    @Valid
    private List<ParameterItem> parameters;
    
    @Data
    public static class ParameterItem {
        @NotBlank(message = "参数键不能为空")
        private String paramKey;
        
        @NotBlank(message = "参数值不能为空")
        private String paramValue;
    }
}
```

### 3.5 参数分类DTO (ParameterCategoryDTO)

```java
@Data
public class ParameterCategoryDTO {
    private String code;
    private String name;
    private String icon;
    private Integer sortOrder;
    private List<ParameterCategoryDTO> subcategories;
    private List<String> parameterKeys;
}
```

### 3.6 参数历史记录DTO (ParameterHistoryDTO)

```java
@Data
public class ParameterHistoryDTO {
    private String id;
    private String paramKey;
    private String oldValue;
    private String newValue;
    private String operation;
    private String operator;
    private Long operateTime;
    private String remark;
}
```

## 4. 接口定义

### 4.1 获取参数列表

**接口地址**: `GET /api/v1/system/parameters`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| category | String | Query | 否 | 参数分类 |
| keyword | String | Query | 否 | 关键字搜索 |
| isSystem | Boolean | Query | 否 | 是否系统参数 |
| visible | Boolean | Query | 否 | 是否可见 |
| page | Integer | Query | 否 | 页码，默认0 |
| size | Integer | Query | 否 | 每页大小，默认20 |

**返回示例**:

```json
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "content": [
            {
                "id": "param-001",
                "paramKey": "company.name",
                "paramValue": "XX财务公司",
                "paramType": "STRING",
                "category": "BASIC",
                "description": "企业名称",
                "isSystem": false,
                "isEncrypted": false,
                "sortOrder": 1,
                "required": true,
                "visible": true,
                "editable": true,
                "effectiveImmediately": true,
                "restartRequired": false,
                "createdAt": 1234567890000,
                "updatedAt": 1234567890000,
                "createdBy": "admin",
                "updatedBy": "admin"
            }
        ],
        "totalElements": 50,
        "totalPages": 3,
        "number": 0,
        "size": 20
    },
    "timestamp": 1234567890000
}
```

### 4.2 获取单个参数

**接口地址**: `GET /api/v1/system/parameters/{key}`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| key | String | Path | 是 | 参数键 |

**返回示例**:

```json
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "id": "param-001",
        "paramKey": "company.name",
        "paramValue": "XX财务公司",
        "paramType": "STRING",
        "category": "BASIC",
        "description": "企业名称",
        "isSystem": false,
        "isEncrypted": false,
        "sortOrder": 1,
        "validationRule": "^[\\u4e00-\\u9fa5A-Za-z0-9]+$",
        "minValue": null,
        "maxValue": null,
        "options": null,
        "defaultValue": "",
        "required": true,
        "visible": true,
        "editable": true,
        "effectiveImmediately": true,
        "restartRequired": false,
        "createdAt": 1234567890000,
        "updatedAt": 1234567890000,
        "createdBy": "admin",
        "updatedBy": "admin"
    },
    "timestamp": 1234567890000
}
```

### 4.3 更新参数

**接口地址**: `PUT /api/v1/system/parameters/{key}`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| key | String | Path | 是 | 参数键 |
| body | SystemParameterUpdateDTO | Body | 是 | 更新数据 |

**请求示例**:

```json
{
    "paramValue": "新的企业名称",
    "description": "企业全称",
    "effectiveImmediately": true
}
```

**返回示例**:

```json
{
    "code": 200,
    "message": "更新成功",
    "data": null,
    "timestamp": 1234567890000
}
```

### 4.4 批量更新参数

**接口地址**: `POST /api/v1/system/parameters/batch`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| body | SystemParameterBatchUpdateDTO | Body | 是 | 批量更新数据 |

**请求示例**:

```json
{
    "parameters": [
        {
            "paramKey": "company.name",
            "paramValue": "新企业名称"
        },
        {
            "paramKey": "company.tax_number",
            "paramValue": "91110000000000000X"
        }
    ]
}
```

**返回示例**:

```json
{
    "code": 200,
    "message": "批量更新成功",
    "data": {
        "successCount": 2,
        "failureCount": 0,
        "failureDetails": []
    },
    "timestamp": 1234567890000
}
```

### 4.5 获取参数分类

**接口地址**: `GET /api/v1/system/parameters/categories`

**请求参数**: 无

**返回示例**:

```json
{
    "code": 200,
    "message": "查询成功",
    "data": [
        {
            "code": "BASIC",
            "name": "基础设置",
            "icon": "Setting",
            "sortOrder": 1,
            "subcategories": [
                {
                    "code": "COMPANY_INFO",
                    "name": "企业信息",
                    "parameterKeys": [
                        "company.name",
                        "company.code",
                        "company.tax_number"
                    ]
                },
                {
                    "code": "ACCOUNTING_POLICY",
                    "name": "会计制度",
                    "parameterKeys": [
                        "accounting.standard",
                        "accounting.currency"
                    ]
                }
            ]
        }
    ],
    "timestamp": 1234567890000
}
```

### 4.6 导出参数配置

**接口地址**: `GET /api/v1/system/parameters/export`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| category | String | Query | 否 | 参数分类，为空导出全部 |

**返回说明**: 
- Content-Type: application/octet-stream
- 返回JSON格式的配置文件

**返回示例**:

```json
{
    "exportTime": "2024-01-01 10:00:00",
    "version": "1.0",
    "parameters": [
        {
            "paramKey": "company.name",
            "paramValue": "XX财务公司",
            "paramType": "STRING",
            "category": "BASIC",
            "description": "企业名称"
        }
    ]
}
```

### 4.7 导入参数配置

**接口地址**: `POST /api/v1/system/parameters/import`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| file | MultipartFile | FormData | 是 | 配置文件 |
| overwrite | Boolean | Query | 否 | 是否覆盖已存在的参数，默认false |

**返回示例**:

```json
{
    "code": 200,
    "message": "导入成功",
    "data": {
        "totalCount": 20,
        "successCount": 18,
        "failureCount": 2,
        "failureDetails": [
            {
                "paramKey": "invalid.key",
                "reason": "参数键格式不正确"
            }
        ]
    },
    "timestamp": 1234567890000
}
```

### 4.8 获取参数修改历史

**接口地址**: `GET /api/v1/system/parameters/{key}/history`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| key | String | Path | 是 | 参数键 |
| startTime | Long | Query | 否 | 开始时间 |
| endTime | Long | Query | 否 | 结束时间 |
| page | Integer | Query | 否 | 页码，默认0 |
| size | Integer | Query | 否 | 每页大小，默认20 |

**返回示例**:

```json
{
    "code": 200,
    "message": "查询成功",
    "data": {
        "content": [
            {
                "id": "hist-001",
                "paramKey": "company.name",
                "oldValue": "旧企业名称",
                "newValue": "新企业名称",
                "operation": "UPDATE",
                "operator": "admin",
                "operateTime": 1234567890000,
                "remark": "更新企业名称"
            }
        ],
        "totalElements": 10,
        "totalPages": 1,
        "number": 0,
        "size": 20
    },
    "timestamp": 1234567890000
}
```

### 4.9 验证参数值

**接口地址**: `POST /api/v1/system/parameters/validate`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| paramKey | String | Body | 是 | 参数键 |
| paramValue | String | Body | 是 | 参数值 |

**请求示例**:

```json
{
    "paramKey": "password.min_length",
    "paramValue": "5"
}
```

**返回示例**:

```json
{
    "code": 200,
    "message": "验证通过",
    "data": {
        "valid": true,
        "errors": []
    },
    "timestamp": 1234567890000
}
```

### 4.10 刷新参数缓存

**接口地址**: `POST /api/v1/system/parameters/refresh`

**请求参数**:

| 参数名 | 类型 | 位置 | 必填 | 说明 |
|--------|------|------|------|------|
| category | String | Query | 否 | 参数分类，为空刷新全部 |

**返回示例**:

```json
{
    "code": 200,
    "message": "缓存刷新成功",
    "data": {
        "refreshedCount": 50
    },
    "timestamp": 1234567890000
}
```

## 5. 错误码定义

| 错误码 | 说明 |
|--------|------|
| 200 | 操作成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 无权限 |
| 404 | 参数不存在 |
| 409 | 参数键已存在 |
| 422 | 参数验证失败 |
| 500 | 服务器内部错误 |

## 6. 权限要求

| 接口 | 权限码 |
|------|--------|
| 获取参数列表 | SYSTEM_PARAM_VIEW |
| 获取单个参数 | SYSTEM_PARAM_VIEW |
| 更新参数 | SYSTEM_PARAM_EDIT |
| 批量更新参数 | SYSTEM_PARAM_EDIT |
| 获取参数分类 | SYSTEM_PARAM_VIEW |
| 导出参数配置 | SYSTEM_PARAM_EXPORT |
| 导入参数配置 | SYSTEM_PARAM_IMPORT |
| 获取参数修改历史 | SYSTEM_PARAM_HISTORY |
| 验证参数值 | SYSTEM_PARAM_VIEW |
| 刷新参数缓存 | SYSTEM_PARAM_ADMIN |

## 7. 注意事项

1. **参数加密**: 标记为加密的参数，在返回时会进行脱敏处理，只显示部分字符
2. **权限控制**: 系统参数(isSystem=true)只有超级管理员可以修改
3. **生效机制**: 
   - effectiveImmediately=true: 修改后立即生效
   - restartRequired=true: 需要重启系统才能生效
4. **参数验证**: 更新参数时会根据validationRule、minValue、maxValue等进行验证
5. **审计日志**: 所有参数修改操作都会记录到审计日志中
6. **缓存策略**: 参数会缓存在Redis中，修改后需要刷新缓存
7. **导入导出**: 导出的配置文件包含参数的完整信息，可用于备份和迁移

## 8. 初始化参数

系统初始化时需要创建以下基础参数：

```sql
-- 企业信息
INSERT INTO system_parameters (id, param_key, param_value, param_type, category, description, is_system, is_encrypted, required, visible, editable, effective_immediately, restart_required, created_at, updated_at, created_by)
VALUES 
('sp-001', 'company.name', '', 'STRING', 'BASIC', '企业名称', 0, 0, 1, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-002', 'company.code', '', 'STRING', 'BASIC', '企业代码', 0, 0, 0, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-003', 'company.tax_number', '', 'STRING', 'BASIC', '税号', 0, 0, 0, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),

-- 会计制度
('sp-004', 'accounting.standard', 'ENTERPRISE', 'ENUM', 'BASIC', '会计准则', 0, 0, 1, 1, 1, 0, 1, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-005', 'accounting.currency', 'CNY', 'STRING', 'BASIC', '记账本位币', 0, 0, 1, 1, 1, 0, 1, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-006', 'accounting.start_date', '', 'DATE', 'BASIC', '账套启用日期', 0, 0, 1, 1, 1, 0, 1, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),

-- 凭证设置
('sp-007', 'voucher.auto_number', 'true', 'BOOLEAN', 'FINANCIAL', '凭证自动编号', 0, 0, 1, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-008', 'voucher.number_rule', 'YEARLY', 'ENUM', 'FINANCIAL', '凭证编号规则', 0, 0, 1, 1, 1, 0, 1, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),

-- 安全设置
('sp-009', 'password.min_length', '8', 'INTEGER', 'SYSTEM', '密码最小长度', 1, 0, 1, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-010', 'password.expire_days', '90', 'INTEGER', 'SYSTEM', '密码有效期(天)', 1, 0, 1, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-011', 'login.max_attempts', '5', 'INTEGER', 'SYSTEM', '最大登录尝试次数', 1, 0, 1, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system'),
('sp-012', 'session.timeout', '1800', 'INTEGER', 'SYSTEM', '会话超时时间(秒)', 1, 0, 1, 1, 1, 1, 0, UNIX_TIMESTAMP(NOW())*1000, UNIX_TIMESTAMP(NOW())*1000, 'system');
```

## 9. 扩展接口（预留）

以下接口为未来扩展预留：

1. **参数模板管理**
   - GET /api/v1/system/parameters/templates - 获取参数模板列表
   - POST /api/v1/system/parameters/templates/apply - 应用参数模板

2. **参数版本管理**
   - GET /api/v1/system/parameters/versions - 获取参数版本历史
   - POST /api/v1/system/parameters/rollback - 回滚到指定版本

3. **参数对比**
   - POST /api/v1/system/parameters/compare - 对比两个版本的参数差异

4. **参数订阅**
   - POST /api/v1/system/parameters/subscribe - 订阅参数变更通知
   - DELETE /api/v1/system/parameters/unsubscribe - 取消订阅