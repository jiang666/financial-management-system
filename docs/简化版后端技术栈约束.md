# 财务系统后端技术栈约束 (简化版)

## 🔧 核心技术栈

### 必须使用的技术
```
## 核心框架
- Spring Boot 2.7.6 (主框架)
- Spring Data JPA (数据库持久层)
- Spring Security (权限认证)
- Lombok (简化代码注解)
- @Slf4j (日志注解)

## 数据库
- MySQL (唯一数据库，存储所有数据)

## 认证授权
- JWT Token认证
- BCryptPasswordEncoder密码加密
```

---

## 📋 数据库设计规范

### MySQL表结构标准
```sql
-- 标准表结构模板
CREATE TABLE table_name (
    -- 1. 主键必须为UUID
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    
    -- 2. 业务字段
    field_name VARCHAR(100) NOT NULL,
    
    -- 3. 审计字段(必须)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(36),
    updated_by VARCHAR(36),
    
    -- 4. 逻辑删除(推荐)
    deleted BOOLEAN DEFAULT FALSE,
    
    -- 5. 版本控制(乐观锁)
    version INT DEFAULT 0,
    
    -- 6. 索引
    INDEX idx_created_at (created_at),
    INDEX idx_field_name (field_name)
);
```

### 数据存储分类
```sql
-- 1. 核心业务数据表
chart_of_accounts     -- 会计科目
vouchers             -- 凭证
voucher_entries      -- 凭证分录
customers            -- 客户
suppliers            -- 供应商
invoices             -- 发票

-- 2. 系统管理表
users                -- 用户
roles                -- 角色
permissions          -- 权限
user_roles           -- 用户角色关联

-- 3. 系统日志表 (替代MongoDB)
system_logs          -- 系统操作日志
audit_trails         -- 数据审计记录
login_logs           -- 登录日志

-- 4. 配置表
system_configs       -- 系统配置
exchange_rates       -- 汇率
currencies           -- 币种
```

---

## 🎯 实体类规范

### 标准实体类模板
```java
@Entity
@Table(name = "table_name")
@Data
@Slf4j
public class EntityName {
    
    @Id
    @GeneratedValue(generator = "uuid")
    @GenericGenerator(name = "uuid", strategy = "uuid2")
    private String id;
    
    // 业务字段
    @Column(nullable = false, length = 100)
    private String fieldName;
    
    // 审计字段
    @CreationTimestamp
    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    
    @Column(name = "created_by", length = 36)
    private String createdBy;
    
    @Column(name = "updated_by", length = 36)
    private String updatedBy;
    
    // 逻辑删除
    @Column(nullable = false)
    private Boolean deleted = false;
    
    // 版本控制
    @Version
    private Integer version = 0;
}
```

### Repository标准
```java
public interface EntityRepository extends JpaRepository<EntityName, String> {
    
    // 查询未删除的记录
    List<EntityName> findByDeletedFalse();
    
    // 按条件查询
    @Query("SELECT e FROM EntityName e WHERE e.deleted = false AND e.fieldName = :value")
    List<EntityName> findByFieldName(@Param("value") String value);
    
    // 分页查询
    Page<EntityName> findByDeletedFalseOrderByCreatedAtDesc(Pageable pageable);
}
```

---

## 🔒 接口返回规范

### 统一响应格式
```java
// 成功响应
return ResponseEntity.success(data);

// 失败响应
return ResponseEntity.fail("错误信息");

// 分页响应
ResponsePageDataEntity<User> pageData = new ResponsePageDataEntity<>();
pageData.setTotal(total);
pageData.setRows(userList);
return ResponseEntity.success(pageData);
```

### Controller标准模板
```java
@RestController
@RequestMapping("/api/entity")
@Slf4j
public class EntityController {
    
    @Autowired
    private EntityService entityService;
    
    @GetMapping
    @PreAuthorize("hasPermission('entity', 'read')")
    public ResponseEntity<List<EntityName>> list() {
        List<EntityName> entities = entityService.findAll();
        log.info("查询实体列表，返回{}条记录", entities.size());
        return ResponseEntity.success(entities);
    }
    
    @PostMapping
    @PreAuthorize("hasPermission('entity', 'create')")
    public ResponseEntity<EntityName> create(@Valid @RequestBody EntityDTO dto) {
        EntityName entity = entityService.create(dto);
        log.info("创建实体成功，ID: {}", entity.getId());
        return ResponseEntity.success(entity);
    }
}
```

---

## 📝 日志管理规范

### 系统日志表设计
```sql
CREATE TABLE system_logs (
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    user_id VARCHAR(36),
    username VARCHAR(50),
    module VARCHAR(50) NOT NULL,
    operation VARCHAR(100) NOT NULL,
    description TEXT,
    ip_address VARCHAR(45),
    user_agent TEXT,
    request_url VARCHAR(500),
    request_method VARCHAR(10),
    response_status INTEGER,
    execution_time BIGINT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_module (module),
    INDEX idx_created_at (created_at)
);
```

### 日志记录服务
```java
@Service
@Slf4j
public class SystemLogService {
    
    @Autowired
    private SystemLogRepository logRepository;
    
    @Async
    public void recordOperation(String userId, String module, String operation, 
                               String description, HttpServletRequest request) {
        SystemLog systemLog = new SystemLog();
        systemLog.setUserId(userId);
        systemLog.setModule(module);
        systemLog.setOperation(operation);
        systemLog.setDescription(description);
        systemLog.setIpAddress(getClientIpAddress(request));
        systemLog.setUserAgent(request.getHeader("User-Agent"));
        systemLog.setRequestUrl(request.getRequestURL().toString());
        systemLog.setRequestMethod(request.getMethod());
        
        logRepository.save(systemLog);
        log.debug("记录系统日志: {}", description);
    }
}
```

---

## ✅ 开发检查清单

### 基础检查
- [ ] 使用Spring Boot + JPA + Security
- [ ] 仅使用MySQL数据库
- [ ] 所有类使用@Slf4j注解
- [ ] 实体类使用UUID主键
- [ ] 包含完整审计字段

### 数据库检查
- [ ] 表名使用snake_case
- [ ] 重要字段建立索引
- [ ] 外键关系正确设置
- [ ] 系统日志表设计完整

### 代码质量检查
- [ ] 接口使用ResponseEntity返回
- [ ] 权限控制使用@PreAuthorize
- [ ] 异常处理统一规范
- [ ] 单元测试覆盖率≥80%

### 安全检查
- [ ] JWT认证配置正确
- [ ] 密码BCrypt加密
- [ ] SQL注入防护
- [ ] 敏感数据脱敏

---

## 🚫 禁用技术清单

```
❌ MongoDB (改为MySQL存储)
❌ PostgreSQL (改为MySQL存储)
❌ Redis (暂不使用缓存)
❌ MyBatis (必须用JPA)
❌ Swagger (暂不生成文档)
❌ Shiro (必须用Spring Security)
```

---

**文档版本**: V2.0 (简化版)  
**更新日期**: 2025-01-19  
**适用项目**: 内部财务管理系统后端