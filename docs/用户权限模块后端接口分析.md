# 用户权限模块后端接口分析

## 1. 概述

基于前端页面分析和数据库表结构设计，用户权限模块采用RBAC（Role-Based Access Control）模型，实现细粒度的权限控制。本文档详细分析前端所需的所有后端接口。

## 2. 数据库表结构概览

### 2.1 核心表
- **tb_user**: 用户信息表
- **tb_role**: 角色信息表
- **tb_resource**: 资源权限表（菜单、按钮、API）
- **tb_user_role**: 用户角色关联表
- **tb_role_resource**: 角色资源关联表

### 2.2 表关系
```
tb_user <---> tb_user_role <---> tb_role <---> tb_role_resource <---> tb_resource
```

## 3. 用户管理接口

### 3.1 查询用户列表
**接口**: `GET /api/users`

**请求参数**:
```json
{
  "username": "string",     // 用户名（模糊查询）
  "realName": "string",     // 真实姓名（模糊查询）
  "roleCode": "string",     // 角色编码
  "status": "string",       // 状态: ACTIVE/INACTIVE
  "page": 0,                // 页码（从0开始）
  "size": 10                // 每页条数
}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "content": [
      {
        "id": "user-001",
        "username": "admin",
        "realName": "系统管理员",
        "email": "admin@company.com",
        "phone": "13800000000",
        "department": "信息技术部",
        "departmentId": "dept-001",
        "status": "ACTIVE",
        "lastLoginAt": 1703123456789,
        "lastLoginIp": "192.168.1.100",
        "roles": [
          {
            "id": "role-001",
            "name": "超级管理员",
            "roleCode": "SUPER_ADMIN"
          }
        ]
      }
    ],
    "totalElements": 100,
    "totalPages": 10,
    "number": 0,
    "size": 10
  }
}
```

### 3.2 创建用户
**接口**: `POST /api/users`

**请求体**:
```json
{
  "username": "zhangsan",
  "password": "123456",
  "realName": "张三",
  "email": "zhangsan@company.com",
  "phone": "13900000000",
  "department": "财务部",
  "departmentId": "dept-002",
  "roleIds": ["role-003"]
}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "创建成功",
  "data": {
    "id": "user-002",
    "username": "zhangsan"
  }
}
```

### 3.3 更新用户信息
**接口**: `PUT /api/users/{id}`

**请求体**:
```json
{
  "realName": "张三",
  "email": "zhangsan@company.com",
  "phone": "13900000000",
  "department": "财务部",
  "departmentId": "dept-002",
  "roleIds": ["role-003"]
}
```

### 3.4 删除用户
**接口**: `DELETE /api/users/{id}`

### 3.5 更新用户状态
**接口**: `PUT /api/users/{id}/status`

**请求体**:
```json
{
  "status": "INACTIVE"
}
```

### 3.6 重置用户密码
**接口**: `PUT /api/users/{id}/password/reset`

**响应数据**:
```json
{
  "code": 0,
  "message": "密码重置成功",
  "data": {
    "newPassword": "123456"
  }
}
```

### 3.7 导出用户列表
**接口**: `GET /api/users/export`

**请求参数**: 同查询用户列表

**响应**: Excel文件流

### 3.8 获取用户详情
**接口**: `GET /api/users/{id}`

### 3.9 检查用户名是否存在
**接口**: `GET /api/users/check-username`

**请求参数**:
```json
{
  "username": "zhangsan",
  "excludeId": "user-001"  // 排除的用户ID（编辑时使用）
}
```

## 4. 角色管理接口

### 4.1 查询角色列表
**接口**: `GET /api/roles`

**请求参数**:
```json
{
  "name": "string",         // 角色名称（模糊查询）
  "roleCode": "string",     // 角色编码（模糊查询）
  "status": "string",       // 状态: ACTIVE/INACTIVE
  "page": 0,
  "size": 10
}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "content": [
      {
        "id": "role-002",
        "roleCode": "FINANCE_MANAGER",
        "name": "财务主管",
        "description": "负责凭证审核、报表查看等",
        "status": "ACTIVE",
        "canDelete": true,
        "canModify": true,
        "userCount": 5
      }
    ],
    "totalElements": 5,
    "totalPages": 1,
    "number": 0,
    "size": 10
  }
}
```

### 4.2 创建角色
**接口**: `POST /api/roles`

**请求体**:
```json
{
  "roleCode": "CUSTOM_ROLE",
  "name": "自定义角色",
  "description": "自定义角色描述"
}
```

### 4.3 更新角色
**接口**: `PUT /api/roles/{id}`

**请求体**:
```json
{
  "name": "自定义角色",
  "description": "更新后的描述"
}
```

### 4.4 删除角色
**接口**: `DELETE /api/roles/{id}`

**业务规则**:
- 系统预置角色（canDelete=false）不能删除
- 有用户使用的角色（userCount>0）不能删除

### 4.5 更新角色状态
**接口**: `PUT /api/roles/{id}/status`

**请求体**:
```json
{
  "status": "INACTIVE"
}
```

### 4.6 获取所有可用角色（下拉选项）
**接口**: `GET /api/roles/options`

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": "role-001",
      "name": "超级管理员",
      "roleCode": "SUPER_ADMIN"
    },
    {
      "id": "role-002",
      "name": "财务主管",
      "roleCode": "FINANCE_MANAGER"
    }
  ]
}
```

## 5. 权限配置接口

### 5.1 获取资源树
**接口**: `GET /api/resources/tree`

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "id": "res-001",
      "resourceCode": "BASIC_SETTINGS",
      "resourceName": "基础设置",
      "resourceType": "TOP_MENU",
      "url": null,
      "icon": "Setting",
      "sortOrder": 1,
      "children": [
        {
          "id": "res-017",
          "resourceCode": "USER_PERMISSION",
          "resourceName": "用户权限",
          "resourceType": "SUB_MENU",
          "url": "/settings/permission",
          "icon": null,
          "sortOrder": 7,
          "children": [
            {
              "id": "res-0171",
              "resourceCode": "USER_ADD",
              "resourceName": "新增用户",
              "resourceType": "BUTTON",
              "url": null,
              "icon": null,
              "sortOrder": 1,
              "children": []
            }
          ]
        }
      ]
    }
  ]
}
```

### 5.2 获取角色权限
**接口**: `GET /api/roles/{roleId}/resources`

**响应数据**:
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "roleId": "role-002",
    "roleName": "财务主管",
    "resourceIds": ["res-001", "res-011", "res-012", "res-021", "res-022"],
    "resources": [
      {
        "id": "res-001",
        "resourceCode": "BASIC_SETTINGS",
        "resourceName": "基础设置",
        "resourceType": "TOP_MENU"
      }
    ]
  }
}
```

### 5.3 保存角色权限
**接口**: `PUT /api/roles/{roleId}/resources`

**请求体**:
```json
{
  "resourceIds": ["res-001", "res-011", "res-012", "res-021", "res-022"]
}
```

### 5.4 获取用户权限树（登录后）
**接口**: `GET /api/users/current/resources`

**响应数据**: 返回当前登录用户有权限访问的资源树，用于前端菜单渲染和按钮权限控制

## 6. 认证相关接口

### 6.1 用户登录
**接口**: `POST /api/auth/login`

**请求体**:
```json
{
  "username": "admin",
  "password": "123456"
}
```

**响应数据**:
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user-001",
      "username": "admin",
      "realName": "系统管理员",
      "roles": ["SUPER_ADMIN"]
    },
    "resources": {
      // 用户权限树
    }
  }
}
```

### 6.2 获取当前用户信息
**接口**: `GET /api/auth/current-user`

### 6.3 修改密码
**接口**: `PUT /api/auth/change-password`

**请求体**:
```json
{
  "oldPassword": "123456",
  "newPassword": "654321"
}
```

### 6.4 退出登录
**接口**: `POST /api/auth/logout`

## 7. 通用查询接口

### 7.1 获取部门列表
**接口**: `GET /api/departments`

**用途**: 用户管理中选择部门

### 7.2 批量操作接口
**接口**: `POST /api/users/batch-delete`

**请求体**:
```json
{
  "ids": ["user-002", "user-003"]
}
```

## 8. 权限控制要求

### 8.1 接口权限
- 所有接口需要进行JWT认证
- 根据用户角色的资源权限进行接口访问控制
- 超级管理员拥有所有接口访问权限

### 8.2 数据权限
- 用户只能查看和编辑自己有权限的数据
- 部门数据隔离（如果启用）
- 敏感信息（如密码）不能返回给前端

## 9. 接口实现注意事项

### 9.1 分页规范
- 使用Spring Data的Pageable接口
- 页码从0开始
- 默认页大小为10

### 9.2 响应格式
```java
@Data
public class ApiResponse<T> {
    private Integer code;    // 0: 成功, 其他: 错误码
    private String message;  // 消息
    private T data;         // 数据
}
```

### 9.3 错误处理
- 400: 请求参数错误
- 401: 未认证
- 403: 无权限
- 404: 资源不存在
- 500: 服务器错误

### 9.4 审计日志
- 所有增删改操作需要记录审计日志
- 记录操作人、操作时间、操作内容

### 9.5 事务处理
- 涉及多表操作的接口需要使用事务
- 如：创建用户同时分配角色

## 10. 性能优化建议

### 10.1 查询优化
- 用户列表查询需要关联角色信息，使用JOIN查询
- 资源树使用递归查询或缓存
- 大量数据使用分页查询

### 10.2 缓存策略
- 资源树结构可以缓存
- 用户权限信息可以缓存到Redis（如果启用）
- 角色权限变更时清除相关缓存

### 10.3 批量操作
- 批量删除使用IN查询
- 批量分配权限使用批量插入

## 11. 总结

用户权限模块共需要实现约30个接口，涵盖用户管理、角色管理、权限配置等功能。通过RBAC模型实现细粒度的权限控制，支持菜单、按钮级别的权限管理。所有接口需要遵循统一的规范和安全要求。