### 数据库表设计约束文档（V2.0）

**目的**：  
本文件定义了团队在设计数据库表时的约束和约定，用于指导AI生成数据库表结构（SQL建表语句、Flyway/Liquibase迁移脚本）或相关建议。AI必须严格遵守以下规则，确保表结构与后端开发技术约束（Spring Data JPA、MySQL/PostgreSQL）一致。如果需求超出约束范围或涉及禁用技术，AI应暂停并请求确认。

**指令**：  
- AI生成表结构时，输出标准的MySQL或PostgreSQL DDL语句，并附带Flyway/Liquibase迁移脚本。  
- 所有表必须映射到Spring Data JPA实体类，遵循后端开发约束的实体类要求。  
- 如果需求不明确或违反约束，AI应：  
  1. 说明违反的约束或缺失的信息。  
  2. 提供符合约束的替代方案。  
  3. 请求用户确认是否调整约束或允许例外。  
- 输出必须包含详细注释，说明设计意图、潜在风险或优化点。  
- 文档和脚本使用Markdown格式。

---

#### 1. 数据库选择
- **默认数据库**：  
  - 使用MySQL 8.x，存储引擎为InnoDB。  
  - 所有表设计默认针对MySQL，除非明确指定其他数据库。  
- **向量数据场景**：  
  - 使用PostgreSQL 14.x+，集成PGVector扩展，用于AI相关的向量数据存储（如嵌入式向量、相似性搜索）。  
  - 向量表由Python服务管理，Java仅通过API调用，表设计需与Python服务接口兼容。  
- **字符集与排序规则**：  
  - MySQL：使用`utf8mb4`字符集，`utf8mb4_unicode_ci`排序规则。  
  - PostgreSQL：使用`UTF8`编码，`en_US.utf8`排序规则。  

#### 2. 表设计通用约束
- **表命名**：  
  - 表名使用小写字母，单词以下划线分隔，带前缀`tb_`（例如：`tb_user_info`）。  
  - 表名应清晰反映业务实体（如`tb_user`、`tb_order`）。  
- **字段命名**：  
  - 字段名使用小写字母，单词以下划线分隔（例如：`create_time`、`role_id`）。  
  - 字段名应简洁、语义明确，避免缩写（如用`username`而非`uname`）。  
- **必含字段**：  
  每个表必须包含以下字段：  
  - `id`：VARCHAR(36)，主键，使用UUID字符串（例如：`550e8400-e29b-41d4-a716-446655440000`）。  
  - `create_time`：BIGINT，存储毫秒时间戳，表示记录创建时间。  
  - `update_time`：BIGINT，存储毫秒时间戳，表示记录最后更新时间。  
  - `create_by`：VARCHAR(50)，存储创建人（当前登录账号）。  
  - `update_by`：VARCHAR(50)，存储更新人（当前登录账号）。  
- **主键约束**：  
  - 每个表必须定义`id`为主键，类型为VARCHAR(36)，使用UUID生成。  
  - 禁用自增ID或其他主键生成策略。  
- **字段类型**：  
  - 字符串：使用VARCHAR，长度根据业务需求设置，默认VARCHAR(255)。  
  - 数值：优先使用BIGINT或INT，禁用FLOAT/DOUBLE（除非明确要求）。  
  - 时间：所有时间字段使用BIGINT（毫秒时间戳），禁用DATETIME、TIMESTAMP等类型。  
  - 布尔：使用TINYINT(1)，0表示false，1表示true。  
- **索引与约束**：  
  - 每个表必须为主键`id`创建主键约束。  
  - 根据查询需求添加普通索引或唯一索引（如`username`需唯一）。  
  - 禁用数据库外键（FOREIGN KEY），外键关系通过应用程序逻辑（Spring Data JPA）管理。  
- **默认值与非空**：  
  - `id`、`create_time`、`update_time`、`create_by`、`update_by`必须为NOT NULL。  
  - 其他字段根据业务需求设置默认值或NOT NULL。  
- **表注释**：  
  - 每个表必须包含表级注释，描述表的功能（如“用户信息表”）。  
  - 每个字段必须包含字段注释，说明用途（如“用户唯一标识”）。  

#### 3. 关系设计约束
- **禁用数据库外键**：  
  - 禁止在表结构中使用FOREIGN KEY约束。  
  - 外键字段作为普通字段（如VARCHAR或BIGINT），通过应用程序逻辑（如JPA的JOIN或Service层）处理关联。  
  - 示例：用户表`tb_user`关联角色表`tb_role`，使用`role_id`（VARCHAR）存储角色ID，不设置外键。  
- **关系管理**：  
  - 禁用JPA关系注解（如`@OneToMany`、`@ManyToOne`），关联查询通过JPA的`JOIN`或Service层实现。  
  - 表设计时，明确标注关联字段（如`role_id`对应`tb_role.id`）。  

#### 4. 数据库迁移
- **工具**：  
  - 使用Flyway或Liquibase管理表结构迁移。  
  - AI生成表结构时，必须附带Flyway（SQL脚本）或Liquibase（YAML/XML）迁移文件。  
- **迁移脚本命名**：  
  - Flyway：`V{version}__{description}.sql`（如`V1__create_user_table.sql`）。  
  - Liquibase：使用`changelog`文件，描述清晰（如`create-user-table.yaml`）。  
- **脚本要求**：  
  - 包含创建表、索引、注释的完整语句。  
  - 确保脚本幂等性（重复执行不报错）。  

#### 5. 禁用技术
- **禁用数据库相关技术**：  
  - **Redis**：禁止用于缓存或存储，表设计不得依赖Redis。  
    - 替代：使用内存缓存（如Ehcache）或数据库表存储临时数据。  
  - **MyBatis及MyBatis-Plus**：禁止用于表操作，表设计必须兼容Spring Data JPA。  
    - 替代：使用JPA的`@Query`或Criteria API处理复杂查询。  
- **AI行为**：  
  - 检查表设计是否涉及禁用技术。  
  - 如果涉及，停止生成，提示禁用原因，建议替代方案，请求用户确认。  

#### 6. AI设计行为规范
- **生成表结构**：  
  - 输出MySQL/PostgreSQL DDL语句，包含表、字段、索引、注释。  
  - 附带Flyway/Liquibase迁移脚本（默认Flyway SQL）。  
  - 确保表结构映射到Spring Data JPA实体类，遵循以下约束：  
    - 必含字段：`id`、`create_time`、`update_time`、`create_by`、`update_by`。  
    - 主键：VARCHAR(36)，UUID。  
    - 时间字段：BIGINT（毫秒时间戳）。  
    - 禁用外键和JPA关系注解。  
  - 示例实体类（与表结构一致）：  
    ```java
    import lombok.AllArgsConstructor;
    import lombok.NoArgsConstructor;
    import javax.persistence.Entity;
    import javax.persistence.Id;
    import javax.persistence.Table;
    import javax.persistence.Column;

    /**
     * 用户信息实体类
     */
    @Entity
    @Table(name = "tb_user_info")
    @NoArgsConstructor
    @AllArgsConstructor
    public class UserInfo {
        @Id
        @Column(name = "id")
        private String id;

        @Column(name = "create_time")
        private Long createTime;

        @Column(name = "update_time")
        private Long createTime;

        @Column(name = "create_by")
        private String createBy;

        @Column(name = "update_by")
        private String updateBy;

        @Column(name = "username")
        private String username;

        @Column(name = "role_id")
        private String roleId;

        // Getters and Setters
    }
    ```
- **生成迁移脚本**：  
  - 示例Flyway脚本：  
    ```sql
    -- V1__create_user_info_table.sql
    CREATE TABLE IF NOT EXISTS tb_user_info (
        id VARCHAR(36) NOT NULL COMMENT '用户唯一标识，UUID',
        create_time BIGINT NOT NULL COMMENT '创建时间，毫秒时间戳',
        update_time BIGINT NOT NULL COMMENT '更新时间，毫秒时间戳',
        create_by VARCHAR(50) NOT NULL COMMENT '创建人，登录账号',
        update_by VARCHAR(50) NOT NULL COMMENT '更新人，登录账号',
        username VARCHAR(255) NOT NULL COMMENT '用户名',
        role_id VARCHAR(36) NOT NULL COMMENT '角色ID，关联tb_role.id',
        PRIMARY KEY (id),
        UNIQUE KEY uk_username (username)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';
    ```
- **注释与说明**：  
  - 表结构和脚本必须包含详细注释（表功能、字段用途）。  
  - 标注潜在风险（如索引缺失可能导致性能问题）。  
- **暂停条件**：  
  - 需求涉及禁用技术（Redis、MyBatis）。  
  - 需求超出约束（如新数据库类型、复杂触发器）。  
  - 返回格式：  
    ```markdown
    **错误**：需求涉及禁用技术[技术名]，原因：[原因]。  
    **建议**：使用[替代方案]。  
    **请确认**：是否允许使用[技术名]或调整约束？
    ```

---

### 使用示例
**用户输入**：设计一个用户表`tb_user`，包含字段`username`（用户名，唯一）、`email`（邮箱）、`role_id`（角色ID，关联角色表）。  
**AI输出**：  
**1. DDL语句**：  
```sql
CREATE TABLE IF NOT EXISTS tb_user (
    id VARCHAR(36) NOT NULL COMMENT '用户唯一标识，UUID',
    create_time BIGINT NOT NULL COMMENT '创建时间，毫秒时间戳',
    update_time BIGINT NOT NULL COMMENT '更新时间，毫秒时间戳',
    create_by VARCHAR(50) NOT NULL COMMENT '创建人，登录账号',
    update_by VARCHAR(50) NOT NULL COMMENT '更新人，登录账号',
    username VARCHAR(255) NOT NULL COMMENT '用户名',
    email VARCHAR(255) COMMENT '邮箱',
    role_id VARCHAR(36) NOT NULL COMMENT '角色ID，关联tb_role.id',
    PRIMARY KEY (id),
    UNIQUE KEY uk_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';
```

**2. Flyway迁移脚本**：  
```sql
-- V1__create_user_table.sql
CREATE TABLE IF NOT EXISTS tb_user (
    id VARCHAR(36) NOT NULL COMMENT '用户唯一标识，UUID',
    create_time BIGINT NOT NULL COMMENT '创建时间，毫秒时间戳',
    update_time BIGINT NOT NULL COMMENT '更新时间，毫秒时间戳',
    create_by VARCHAR(50) NOT NULL COMMENT '创建人，登录账号',
    update_by VARCHAR(50) NOT NULL COMMENT '更新人，登录账号',
    username VARCHAR(255) NOT NULL COMMENT '用户名',
    email VARCHAR(255) COMMENT '邮箱',
    role_id VARCHAR(36) NOT NULL COMMENT '角色ID，关联tb_role.id',
    PRIMARY KEY (id),
    UNIQUE KEY uk_username (username)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';
```

**3. 对应的JPA实体类**：  
```java
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.persistence.Column;

/**
 * 用户实体类
 */
@Entity
@Table(name = "tb_user")
@NoArgsConstructor
@AllArgsConstructor
public class User {
    @Id
    @Column(name = "id")
    private String id;

    @Column(name = "create_time")
    private Long createTime;

    @Column(name = "update_time")
    private Long updateTime;

    @Column(name = "create_by")
    private String createBy;

    @Column(name = "update_by")
    private String updateBy;

    @Column(name = "username")
    private String username;

    @Column(name = "email")
    private String email;

    @Column(name = "role_id")
    private String roleId;

    // Getters and Setters
}
```

**注释**：  
- 表包含必含字段（`id`、`create_time`、`update_time`、`create_by`、`update_by`）。  
- `id`为VARCHAR(36)，使用UUID。  
- 时间字段使用BIGINT（毫秒时间戳）。  
- `role_id`作为普通字段，无外键约束。  
- 添加`username`唯一索引，支持快速查询。  
- 脚本确保幂等性（`IF NOT EXISTS`）。  
- **风险**：若`email`需唯一性，需添加UNIQUE KEY，请确认。
