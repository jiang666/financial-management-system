# 数据库设计约束提示词

## 🗄️ 数据库选型约束

### 三种数据库的使用场景

```
仅允许使用以下三种数据库，严格按场景划分：

## MySQL (关系型 - 主要业务数据)
✅ 用户管理、角色权限
✅ 业务核心数据 (订单、产品等)
✅ 配置信息、系统设置
✅ 需要事务保证的数据
✅ 关系复杂的结构化数据

## MongoDB (文档型 - 灵活数据)
✅ 系统日志、操作记录
✅ 文档存储、内容管理
✅ 非结构化数据
✅ 快速读写的缓存数据
✅ 数据结构经常变化的场景

## PostgreSQL (关系型 + 向量 - AI数据)
✅ AI向量存储 (pgvector扩展)
✅ 文档嵌入向量、语义搜索
✅ 机器学习特征数据
✅ 复杂查询和分析
✅ 需要向量相似度计算的场景
```

------

## 📋 MySQL设计约束

### 表结构规范

```sql
-- 必须遵守的表结构规范
CREATE TABLE table_name (
    -- 1. 主键必须为UUID类型
    id VARCHAR(36) PRIMARY KEY DEFAULT (UUID()),
    
    -- 2. 必须有创建和更新时间
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    -- 3. 逻辑删除字段 (推荐)
    deleted BOOLEAN DEFAULT FALSE,
    
    -- 4. 版本控制字段 (乐观锁)
    version INT DEFAULT 0,
    
    -- 业务字段...
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) UNIQUE,
    
    -- 5. 索引规范
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_created_at (created_at)
);
```

### 命名规范

```
表名：snake_case，复数形式 (users, user_roles, order_items)
字段名：snake_case (user_name, created_at, is_active)
索引名：idx_字段名 (idx_username, idx_created_at)
外键名：fk_表名_字段名 (fk_users_role_id)
```

### 字段类型约束

```sql
-- 字符串类型
VARCHAR(50)     -- 短文本 (用户名、状态等)
VARCHAR(255)    -- 中等文本 (邮箱、地址等)
TEXT           -- 长文本 (描述、内容等)

-- 数值类型
TINYINT        -- 布尔值、状态码
INT            -- 计数、数量
BIGINT         -- 大数值、时间戳
DECIMAL(10,2)  -- 金额、精确小数

-- 时间类型
TIMESTAMP      -- 创建时间、更新时间
DATE           -- 日期
TIME           -- 时间
```

------

## 📄 MongoDB设计约束

### 文档结构规范

```javascript
// 系统日志文档结构
{
  "_id": ObjectId(), // MongoDB自动生成
  "level": "INFO",   // 日志级别
  "message": "用户登录成功",
  "module": "auth",  // 模块名称
  "userId": "uuid-string", // 关联的MySQL用户ID
  "timestamp": ISODate("2025-01-15T10:30:00Z"),
  "details": {       // 嵌套文档
    "ip": "192.168.1.1",
    "userAgent": "Mozilla/5.0...",
    "action": "login"
  },
  "tags": ["auth", "success"], // 数组字段
  "metadata": {}     // 动态字段
}

// 内容文档结构  
{
  "_id": ObjectId(),
  "title": "文档标题",
  "content": "文档内容...", 
  "type": "article",
  "author": {        // 嵌套对象
    "id": "uuid-string",
    "name": "作者名"
  },
  "categories": ["tech", "ai"], // 分类数组
  "status": "published",
  "createdAt": ISODate(),
  "updatedAt": ISODate(),
  "version": 1
}
```

### 集合命名规范

```
集合名：snake_case，复数形式
system_logs, user_activities, content_documents
document_templates, ai_chat_histories
```

### 索引策略

```javascript
// 常用查询字段建立索引
db.system_logs.createIndex({ "level": 1, "timestamp": -1 })
db.system_logs.createIndex({ "userId": 1 })
db.system_logs.createIndex({ "module": 1, "timestamp": -1 })

// 复合索引
db.content_documents.createIndex({ "type": 1, "status": 1, "createdAt": -1 })

// 文本搜索索引
db.content_documents.createIndex({ "title": "text", "content": "text" })
```

------

## 🤖 PostgreSQL设计约束

### 向量表结构规范

```sql
-- 必须安装pgvector扩展
CREATE EXTENSION IF NOT EXISTS vector;

-- AI向量存储表
CREATE TABLE document_embeddings (
    -- 1. 主键UUID
    id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
    
    -- 2. 向量字段 (维度根据模型决定)
    embedding vector(1536), -- OpenAI embedding维度
    
    -- 3. 关联字段
    document_id VARCHAR(36) NOT NULL,    -- 关联文档ID
    content TEXT NOT NULL,               -- 原始内容
    content_hash VARCHAR(64),            -- 内容hash，避免重复
    
    -- 4. 元数据
    model_name VARCHAR(50) DEFAULT 'text-embedding-ada-002',
    chunk_index INTEGER DEFAULT 0,      -- 文档分块索引
    token_count INTEGER,                -- token数量
    
    -- 5. 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 6. 索引
    UNIQUE(document_id, content_hash)
);

-- 向量索引 (提高相似度搜索性能)
CREATE INDEX ON document_embeddings USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- 传统索引
CREATE INDEX idx_document_embeddings_document_id ON document_embeddings(document_id);
CREATE INDEX idx_document_embeddings_created_at ON document_embeddings(created_at);
```

### 向量查询规范

```sql
-- 相似度搜索 (余弦相似度)
SELECT 
    id, content, document_id,
    1 - (embedding <=> '[0.1,0.2,0.3,...]'::vector) as similarity
FROM document_embeddings 
ORDER BY embedding <=> '[0.1,0.2,0.3,...]'::vector
LIMIT 10;

-- 欧几里得距离搜索
SELECT id, content, embedding <-> '[0.1,0.2,0.3,...]'::vector as distance
FROM document_embeddings 
ORDER BY embedding <-> '[0.1,0.2,0.3,...]'::vector
LIMIT 10;

-- 结合条件的向量搜索
SELECT *
FROM document_embeddings 
WHERE document_id = ? 
ORDER BY embedding <=> ?::vector
LIMIT 5;
```

------

## 🔗 跨数据库关联约束

### 数据一致性规则

```
1. 主实体存储在MySQL (如用户、订单)
2. 扩展信息存储在MongoDB (如日志、活动记录)  
3. AI相关数据存储在PostgreSQL (如向量、推荐)

关联方式：
- 使用UUID作为跨数据库的外键
- MySQL的主键 → MongoDB的关联字段
- MySQL的主键 → PostgreSQL的关联字段
```

### 数据同步策略

```java
// 示例：用户创建时的多数据库操作
@Service
@Transactional
public class UserService {
    
    public void createUser(User user) {
        // 1. MySQL存储主要信息
        User savedUser = userRepository.save(user);
        
        // 2. MongoDB记录操作日志
        SystemLog log = new SystemLog();
        log.setUserId(savedUser.getId());
        log.setMessage("用户创建成功");
        logRepository.save(log);
        
        // 3. PostgreSQL初始化用户向量
        initUserEmbedding(savedUser.getId());
    }
}
```

------

## 📝 完整数据库约束提示词

```
【数据库设计约束】
仅限三种数据库：MySQL(业务核心) + MongoDB(日志文档) + PostgreSQL(AI向量)

【MySQL约束】
- 表名/字段名：snake_case
- 主键：VARCHAR(36) UUID 
- 必须字段：id, created_at, updated_at
- 推荐字段：deleted, version
- 索引：主要查询字段建立索引

【MongoDB约束】
- 集合名：snake_case复数形式
- 文档结构：嵌套对象、数组合理使用
- 索引：查询字段、复合索引、文本索引
- 关联：使用MySQL的UUID作为外键

【PostgreSQL约束】  
- 必须安装pgvector扩展
- 向量字段：vector(1536)
- 向量索引：ivfflat + vector_cosine_ops
- 查询：<=> 余弦相似度，<-> 欧几里得距离

【跨库关联】
UUID作为统一主键，MySQL主实体 → MongoDB扩展 → PostgreSQL向量
```

------

## ✅ 数据库设计检查清单

**MySQL检查：**

- [ ] 表名使用snake_case复数形式
- [ ] 主键为VARCHAR(36) UUID类型
- [ ] 包含created_at、updated_at字段
- [ ] 重要查询字段建立索引
- [ ] 字段类型选择合理

**MongoDB检查：**

- [ ] 集合名使用snake_case复数形式
- [ ] 文档结构设计合理
- [ ] 查询字段建立索引
- [ ] 使用MySQL的UUID关联

**PostgreSQL检查：**

- [ ] 安装pgvector扩展
- [ ] 向量字段定义正确
- [ ] 向量索引创建完整
- [ ] 相似度查询语法正确

**跨库设计检查：**

- [ ] UUID统一主键策略
- [ ] 数据库职责划分清晰
- [ ] 关联关系设计合理
- [ ] 数据同步策略明确

这样可以确保数据库设计的规范性和一致性！