# 币种汇率模块后端接口设计文档

## 一、外部汇率API分析

### 1.1 Frankfurter API 特点
- **免费无需密钥**：`https://api.frankfurter.dev/v1/latest`
- **支持多基准币种**：可以指定任意币种作为基准
- **实时汇率数据**：每日更新
- **响应格式**：JSON格式，结构简单清晰

### 1.2 API响应示例
```json
{
  "amount": 1,
  "base": "CNY",
  "date": "2025-08-22",
  "rates": {
    "EUR": 0.12,
    "GBP": 0.10384,
    "JPY": 20.712,
    "USD": 0.1393
  }
}
```

## 二、页面功能与接口对应分析

基于前端界面分析，需要以下功能对应的后端接口：

### 2.1 基础数据展示
- 币种列表展示（表格数据）
- 搜索和筛选功能
- 分页加载

### 2.2 币种管理操作
- 新增币种
- 编辑币种信息
- 删除币种
- 启用/停用币种
- 设置基准币种

### 2.3 汇率管理操作
- 手动修改单个币种汇率
- 批量更新所有币种汇率（调用外部API）
- 查看汇率历史记录

## 三、后端接口设计

### 3.1 币种列表查询

#### 接口信息
- **方法**：`GET`
- **路径**：`/api/v1/currencies`
- **描述**：获取币种列表，支持搜索、筛选、分页

#### 请求参数
```typescript
interface CurrencyListRequest {
  // 分页参数
  page?: number           // 页码，从0开始，默认0
  size?: number           // 每页大小，默认20
  
  // 搜索参数
  code?: string          // 币种代码，支持模糊查询
  name?: string          // 币种名称，支持模糊查询
  status?: string        // 状态筛选：ACTIVE/INACTIVE
  isBase?: boolean       // 是否基准币种筛选
  
  // 排序参数
  sort?: string          // 排序字段，如：code,asc 或 updateTime,desc
}
```

#### 响应数据
```typescript
interface CurrencyListResponse {
  code: number
  message: string
  data: {
    content: Currency[]
    totalElements: number
    totalPages: number
    number: number
    size: number
    first: boolean
    last: boolean
  }
}

interface Currency {
  id: string                    // 币种ID
  code: string                 // 币种代码（如：USD）
  name: string                 // 币种名称（如：美元）
  symbol: string               // 币种符号（如：$）
  exchangeRate: number         // 汇率（小数点后4位）
  isBase: boolean              // 是否基准币种
  status: string               // 状态：ACTIVE/INACTIVE
  remark?: string              // 备注
  createdAt: string           // 创建时间
  updatedAt: string           // 更新时间
  updatedBy: string           // 更新人
}
```

### 3.2 新增币种

#### 接口信息
- **方法**：`POST`
- **路径**：`/api/v1/currencies`
- **描述**：新增币种

#### 请求参数
```typescript
interface CreateCurrencyRequest {
  code: string              // 币种代码，必填，3位大写字母
  name: string              // 币种名称，必填
  symbol: string            // 币种符号，必填
  exchangeRate: number      // 汇率，选填，默认1.0000
  isBase?: boolean          // 是否基准币种，默认false
  remark?: string           // 备注，选填
}
```

#### 响应数据
```typescript
interface CreateCurrencyResponse {
  code: number
  message: string
  data: {
    id: string              // 新创建的币种ID
  }
}
```

### 3.3 编辑币种

#### 接口信息
- **方法**：`PUT`
- **路径**：`/api/v1/currencies/{id}`
- **描述**：更新币种信息

#### 请求参数
```typescript
interface UpdateCurrencyRequest {
  name?: string             // 币种名称
  symbol?: string           // 币种符号
  exchangeRate?: number     // 汇率
  remark?: string           // 备注
}
```

#### 响应数据
```typescript
interface UpdateCurrencyResponse {
  code: number
  message: string
  data: null
}
```

### 3.4 删除币种

#### 接口信息
- **方法**：`DELETE`
- **路径**：`/api/v1/currencies/{id}`
- **描述**：删除币种（逻辑删除）

#### 请求参数
- 路径参数：`id` - 币种ID

#### 响应数据
```typescript
interface DeleteCurrencyResponse {
  code: number
  message: string
  data: null
}
```

### 3.5 更新币种状态

#### 接口信息
- **方法**：`PUT`
- **路径**：`/api/v1/currencies/{id}/status`
- **描述**：启用或停用币种

#### 请求参数
```typescript
interface UpdateStatusRequest {
  status: string            // ACTIVE 或 INACTIVE
}
```

#### 响应数据
```typescript
interface UpdateStatusResponse {
  code: number
  message: string
  data: null
}
```

### 3.6 设置基准币种

#### 接口信息
- **方法**：`PUT`
- **路径**：`/api/v1/currencies/{id}/base`
- **描述**：设置某个币种为基准币种

#### 请求参数
- 路径参数：`id` - 币种ID

#### 响应数据
```typescript
interface SetBaseCurrencyResponse {
  code: number
  message: string
  data: {
    message: string         // 操作结果说明
    affectedCurrencies: number  // 受影响的币种数量
  }
}
```

### 3.7 更新单个币种汇率

#### 接口信息
- **方法**：`PUT`
- **路径**：`/api/v1/currencies/{id}/rate`
- **描述**：手动更新单个币种的汇率

#### 请求参数
```typescript
interface UpdateRateRequest {
  exchangeRate: number      // 新汇率值
  remark?: string           // 更新备注
}
```

#### 响应数据
```typescript
interface UpdateRateResponse {
  code: number
  message: string
  data: {
    oldRate: number         // 原汇率
    newRate: number         // 新汇率
    changeAmount: number    // 变动金额
    changePercent: number   // 变动百分比
  }
}
```

### 3.8 批量更新汇率

#### 接口信息
- **方法**：`POST`
- **路径**：`/api/v1/currencies/rates/sync`
- **描述**：从外部API同步汇率数据

#### 请求参数
```typescript
interface SyncRatesRequest {
  baseCurrency?: string     // 基准币种，默认使用系统设置的基准币种
  symbols?: string[]        // 要更新的币种列表，空则更新所有
  force?: boolean           // 是否强制更新，默认false
}
```

#### 响应数据
```typescript
interface SyncRatesResponse {
  code: number
  message: string
  data: {
    syncTime: string        // 同步时间
    baseCurrency: string    // 基准币种
    successCount: number    // 成功更新数量
    failureCount: number    // 失败数量
    failures: string[]      // 失败的币种列表
    rateUpdates: RateUpdate[]  // 汇率更新详情
  }
}

interface RateUpdate {
  currencyCode: string      // 币种代码
  oldRate: number          // 原汇率
  newRate: number          // 新汇率
  changeAmount: number     // 变动金额
  changePercent: number    // 变动百分比
}
```

### 3.9 获取汇率历史

#### 接口信息
- **方法**：`GET`
- **路径**：`/api/v1/currencies/rates/history`
- **描述**：查询汇率变动历史

#### 请求参数
```typescript
interface RateHistoryRequest {
  // 分页参数
  page?: number           // 页码，默认0
  size?: number           // 每页大小，默认20
  
  // 查询条件
  currencyCode?: string   // 币种代码，为空则查询所有
  startDate?: string      // 开始日期，格式：yyyy-MM-dd
  endDate?: string        // 结束日期，格式：yyyy-MM-dd
  updateSource?: string   // 更新来源：MANUAL/API/SYSTEM
  
  // 排序
  sort?: string          // 排序，默认：createdAt,desc
}
```

#### 响应数据
```typescript
interface RateHistoryResponse {
  code: number
  message: string
  data: {
    content: RateHistory[]
    totalElements: number
    totalPages: number
    number: number
    size: number
  }
}

interface RateHistory {
  id: string                    // 历史记录ID
  currencyCode: string         // 币种代码
  currencyName: string         // 币种名称
  oldRate: number              // 原汇率
  newRate: number              // 新汇率
  changeAmount: number         // 变动金额
  changePercent: number        // 变动百分比（小数形式）
  updateSource: string         // 更新来源
  operator: string             // 操作人
  createdAt: string           // 更新时间
  remark?: string             // 备注
}
```

### 3.10 获取单个币种详情

#### 接口信息
- **方法**：`GET`
- **路径**：`/api/v1/currencies/{id}`
- **描述**：获取单个币种的详细信息

#### 请求参数
- 路径参数：`id` - 币种ID

#### 响应数据
```typescript
interface CurrencyDetailResponse {
  code: number
  message: string
  data: Currency
}
```

### 3.11 获取基准币种信息

#### 接口信息
- **方法**：`GET`
- **路径**：`/api/v1/currencies/base`
- **描述**：获取当前系统的基准币种信息

#### 请求参数
- 无

#### 响应数据
```typescript
interface BaseCurrencyResponse {
  code: number
  message: string
  data: {
    baseCurrency: Currency
    lastSyncTime?: string     // 最后同步时间
    nextSyncTime?: string     // 下次同步时间（如果有定时任务）
  }
}
```

## 四、外部API集成接口

### 4.1 测试外部汇率API连接

#### 接口信息
- **方法**：`GET`
- **路径**：`/api/v1/currencies/rates/test-connection`
- **描述**：测试外部汇率API的连接状态

#### 请求参数
```typescript
interface TestConnectionRequest {
  baseCurrency?: string     // 测试用的基准币种，默认CNY
}
```

#### 响应数据
```typescript
interface TestConnectionResponse {
  code: number
  message: string
  data: {
    connected: boolean      // 是否连接成功
    apiUrl: string          // API地址
    responseTime: number    // 响应时间（毫秒）
    lastUpdateDate: string  // API数据最后更新日期
    availableCurrencies: string[]  // 可用币种列表
    error?: string          // 错误信息（如果连接失败）
  }
}
```

## 五、错误码设计

```typescript
enum CurrencyErrorCodes {
  // 通用错误
  CURRENCY_NOT_FOUND = 40001,           // 币种不存在
  CURRENCY_CODE_EXISTS = 40002,         // 币种代码已存在
  INVALID_CURRENCY_CODE = 40003,        // 无效的币种代码格式
  
  // 基准币种相关
  BASE_CURRENCY_REQUIRED = 40101,       // 系统必须有一个基准币种
  BASE_CURRENCY_CANNOT_DELETE = 40102,  // 基准币种不能删除
  MULTIPLE_BASE_CURRENCIES = 40103,     // 不能有多个基准币种
  
  // 汇率相关
  INVALID_EXCHANGE_RATE = 40201,        // 无效的汇率值
  RATE_UPDATE_FAILED = 40202,           // 汇率更新失败
  EXTERNAL_API_ERROR = 40203,           // 外部API调用失败
  
  // 业务逻辑错误
  CURRENCY_IN_USE = 40301,              // 币种正在使用中，不能删除
  INACTIVE_CURRENCY_OPERATION = 40302,  // 对停用币种的非法操作
}
```

## 六、接口调用顺序

### 6.1 页面初始化
1. `GET /api/v1/currencies` - 加载币种列表
2. `GET /api/v1/currencies/base` - 获取基准币种信息

### 6.2 新增币种流程
1. `POST /api/v1/currencies` - 创建币种
2. `GET /api/v1/currencies` - 刷新列表

### 6.3 编辑币种流程
1. `GET /api/v1/currencies/{id}` - 获取币种详情
2. `PUT /api/v1/currencies/{id}` - 更新币种
3. `GET /api/v1/currencies` - 刷新列表

### 6.4 汇率更新流程
1. `POST /api/v1/currencies/rates/sync` - 批量同步汇率
2. `GET /api/v1/currencies` - 刷新列表显示新汇率

### 6.5 查看汇率历史流程
1. `GET /api/v1/currencies/rates/history` - 获取历史数据

## 七、性能和缓存考虑

1. **币种列表缓存**：由于币种数据相对稳定，可以缓存15分钟
2. **汇率数据缓存**：实时性要求高，缓存时间不超过5分钟
3. **历史记录分页**：大量历史数据需要分页查询
4. **外部API限流**：避免频繁调用外部汇率API

## 八、安全考虑

1. **权限控制**：汇率修改需要特定权限
2. **操作审计**：重要操作需记录操作人和时间
3. **数据校验**：汇率数据合理性检查
4. **防重复提交**：避免重复更新汇率