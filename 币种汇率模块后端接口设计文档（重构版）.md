# 币种汇率模块后端接口设计文档（重构版）

## 一、设计约束与规范

### 1.1 基础约束
根据数据库表结构设计和后端技术约束文档，本模块严格遵守以下约束：

- **主键**: 使用 VARCHAR(36) 存储UUID
- **时间字段**: 使用 BIGINT 存储毫秒时间戳
- **审计字段**: created_at, updated_at, created_by, updated_by
- **逻辑删除**: 使用 `deleted` 字段 (TINYINT(1))
- **金额精度**: DECIMAL(15,8) 确保汇率精度
- **技术栈**: Spring Boot + Spring Data JPA + MySQL

### 1.2 数据库表结构参照

#### 币种表 (currencies) - 已存在
```sql
CREATE TABLE currencies (
    id VARCHAR(36) PRIMARY KEY COMMENT '币种ID',
    code VARCHAR(3) NOT NULL UNIQUE COMMENT '币种代码',
    name VARCHAR(50) NOT NULL COMMENT '币种名称',
    name_en VARCHAR(50) COMMENT '英文名称',
    symbol VARCHAR(10) COMMENT '币种符号',
    is_base TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否本位币',
    decimal_places INT NOT NULL DEFAULT 2 COMMENT '小数位数',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态: 1-启用 0-禁用',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_at BIGINT NOT NULL COMMENT '创建时间',
    updated_at BIGINT NOT NULL COMMENT '更新时间',
    created_by VARCHAR(36) COMMENT '创建人',
    updated_by VARCHAR(36) COMMENT '更新人',
    deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除'
);
```

#### 汇率表 (exchange_rates) - 已存在
```sql
CREATE TABLE exchange_rates (
    id VARCHAR(36) PRIMARY KEY COMMENT '汇率ID',
    from_currency_id VARCHAR(36) NOT NULL COMMENT '源币种ID',
    to_currency_id VARCHAR(36) NOT NULL COMMENT '目标币种ID',
    rate DECIMAL(15,8) NOT NULL COMMENT '汇率',
    rate_type ENUM('SPOT', 'FORWARD', 'AVERAGE') NOT NULL DEFAULT 'SPOT' COMMENT '汇率类型',
    effective_date BIGINT NOT NULL COMMENT '生效日期',
    expiry_date BIGINT COMMENT '失效日期',
    source VARCHAR(50) COMMENT '汇率来源',
    status TINYINT(1) NOT NULL DEFAULT 1 COMMENT '状态: 1-启用 0-禁用',
    created_at BIGINT NOT NULL COMMENT '创建时间',
    updated_at BIGINT NOT NULL COMMENT '更新时间',
    created_by VARCHAR(36) COMMENT '创建人',
    updated_by VARCHAR(36) COMMENT '更新人',
    deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否删除'
);
```

### 1.3 外部汇率API
- **服务**: Frankfurter API (`https://api.frankfurter.dev/v1/latest`)
- **特点**: 免费无需密钥，支持多基准币种
- **响应格式**:
```json
{
  "amount": 1,
  "base": "CNY",
  "date": "2025-08-22",
  "rates": {
    "USD": 0.1393,
    "EUR": 0.12,
    "GBP": 0.10384,
    "JPY": 20.712
  }
}
```

## 二、后端实体设计

### 2.1 Currency 实体类
```java
package com.company.financial.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.*;

@Entity
@Table(name = "currencies")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Currency {
    
    @Id
    @Column(name = "id")
    private String id;
    
    @Column(name = "code")
    private String code;
    
    @Column(name = "name")
    private String name;
    
    @Column(name = "name_en")
    private String nameEn;
    
    @Column(name = "symbol")
    private String symbol;
    
    @Column(name = "is_base")
    private Integer isBase;
    
    @Column(name = "decimal_places")
    private Integer decimalPlaces;
    
    @Column(name = "status")
    private Integer status;
    
    @Column(name = "sort_order")
    private Integer sortOrder;
    
    @Column(name = "created_at")
    private Long createdAt;
    
    @Column(name = "updated_at")
    private Long updatedAt;
    
    @Column(name = "created_by")
    private String createdBy;
    
    @Column(name = "updated_by")
    private String updatedBy;
    
    @Column(name = "deleted")
    private Integer deleted;
}
```

### 2.2 ExchangeRate 实体类
```java
package com.company.financial.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import javax.persistence.*;
import java.math.BigDecimal;

@Entity
@Table(name = "exchange_rates")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ExchangeRate {
    
    @Id
    @Column(name = "id")
    private String id;
    
    @Column(name = "from_currency_id")
    private String fromCurrencyId;
    
    @Column(name = "to_currency_id")
    private String toCurrencyId;
    
    @Column(name = "rate")
    private BigDecimal rate;
    
    @Column(name = "rate_type")
    private String rateType;
    
    @Column(name = "effective_date")
    private Long effectiveDate;
    
    @Column(name = "expiry_date")
    private Long expiryDate;
    
    @Column(name = "source")
    private String source;
    
    @Column(name = "status")
    private Integer status;
    
    @Column(name = "created_at")
    private Long createdAt;
    
    @Column(name = "updated_at")
    private Long updatedAt;
    
    @Column(name = "created_by")
    private String createdBy;
    
    @Column(name = "updated_by")
    private String updatedBy;
    
    @Column(name = "deleted")
    private Integer deleted;
}
```

## 三、后端接口设计

### 3.1 币种列表查询

#### 接口信息
- **方法**: `GET`
- **路径**: `/api/v1/currencies`
- **描述**: 获取币种列表，支持搜索、筛选、分页

#### 请求参数
| 参数名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| page | Integer | 否 | 0 | 页码，从0开始 |
| size | Integer | 否 | 20 | 每页大小 |
| code | String | 否 | - | 币种代码，支持模糊查询 |
| name | String | 否 | - | 币种名称，支持模糊查询 |
| status | Integer | 否 | - | 状态筛选：1-启用，0-禁用 |
| isBase | Integer | 否 | - | 是否本位币：1-是，0-否 |
| sort | String | 否 | created_at,desc | 排序字段和方向 |

#### 响应数据
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [
      {
        "id": "curr-001",
        "code": "CNY",
        "name": "人民币",
        "nameEn": "Chinese Yuan",
        "symbol": "￥",
        "isBase": 1,
        "decimalPlaces": 2,
        "status": 1,
        "sortOrder": 1,
        "currentRate": 1.00000000,
        "lastRateUpdate": 1693190400000,
        "createdAt": 1693190400000,
        "updatedAt": 1693190400000,
        "createdBy": "system",
        "updatedBy": "system"
      }
    ],
    "totalElements": 5,
    "totalPages": 1,
    "number": 0,
    "size": 20,
    "first": true,
    "last": true,
    "numberOfElements": 5
  }
}
```

### 3.2 新增币种

#### 接口信息
- **方法**: `POST`
- **路径**: `/api/v1/currencies`
- **描述**: 新增币种

#### 请求参数
```json
{
  "code": "HKD",
  "name": "港币",
  "nameEn": "Hong Kong Dollar",
  "symbol": "HK$",
  "decimalPlaces": 2,
  "sortOrder": 10
}
```

#### 响应数据
```json
{
  "code": 200,
  "message": "币种创建成功",
  "data": {
    "id": "curr-hkd-001"
  }
}
```

### 3.3 编辑币种

#### 接口信息
- **方法**: `PUT`
- **路径**: `/api/v1/currencies/{id}`
- **描述**: 更新币种基本信息

#### 请求参数
```json
{
  "name": "港币",
  "nameEn": "Hong Kong Dollar",
  "symbol": "HK$",
  "decimalPlaces": 2,
  "sortOrder": 10
}
```

#### 响应数据
```json
{
  "code": 200,
  "message": "币种更新成功",
  "data": null
}
```

### 3.4 删除币种

#### 接口信息
- **方法**: `DELETE`
- **路径**: `/api/v1/currencies/{id}`
- **描述**: 逻辑删除币种

#### 响应数据
```json
{
  "code": 200,
  "message": "币种删除成功",
  "data": null
}
```

### 3.5 更新币种状态

#### 接口信息
- **方法**: `PUT`
- **路径**: `/api/v1/currencies/{id}/status`
- **描述**: 启用或禁用币种

#### 请求参数
```json
{
  "status": 1
}
```

#### 响应数据
```json
{
  "code": 200,
  "message": "币种状态更新成功",
  "data": null
}
```

### 3.6 设置本位币

#### 接口信息
- **方法**: `PUT`
- **路径**: `/api/v1/currencies/{id}/base`
- **描述**: 设置某个币种为本位币

#### 响应数据
```json
{
  "code": 200,
  "message": "本位币设置成功",
  "data": {
    "previousBaseCurrency": "curr-001",
    "newBaseCurrency": "curr-002",
    "affectedRates": 4
  }
}
```

### 3.7 获取当前汇率

#### 接口信息
- **方法**: `GET`
- **路径**: `/api/v1/currencies/{currencyId}/rate`
- **描述**: 获取指定币种的当前汇率

#### 请求参数
| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| baseCurrencyId | String | 否 | 基准币种ID，不传则使用系统本位币 |

#### 响应数据
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "currencyId": "curr-002",
    "currencyCode": "USD",
    "currencyName": "美元",
    "baseCurrencyId": "curr-001",
    "baseCurrencyCode": "CNY",
    "rate": 7.23650000,
    "rateType": "SPOT",
    "effectiveDate": 1693190400000,
    "source": "FRANKFURTER_API",
    "lastUpdated": 1693190400000
  }
}
```

### 3.8 手动更新汇率

#### 接口信息
- **方法**: `PUT`
- **路径**: `/api/v1/currencies/{currencyId}/rate`
- **描述**: 手动更新指定币种的汇率

#### 请求参数
```json
{
  "rate": 7.2500,
  "effectiveDate": 1693190400000,
  "remark": "手动调整汇率"
}
```

#### 响应数据
```json
{
  "code": 200,
  "message": "汇率更新成功",
  "data": {
    "currencyCode": "USD",
    "oldRate": 7.23650000,
    "newRate": 7.25000000,
    "changeAmount": 0.01350000,
    "changePercent": 0.0019,
    "effectiveDate": 1693190400000
  }
}
```

### 3.9 批量同步汇率

#### 接口信息
- **方法**: `POST`
- **路径**: `/api/v1/currencies/rates/sync`
- **描述**: 从外部API批量同步汇率

#### 请求参数
```json
{
  "baseCurrencyCode": "CNY",
  "targetCurrencyCodes": ["USD", "EUR", "GBP", "JPY"],
  "forceUpdate": false
}
```

#### 响应数据
```json
{
  "code": 200,
  "message": "汇率同步完成",
  "data": {
    "syncTime": 1693190400000,
    "baseCurrency": "CNY",
    "successCount": 4,
    "failureCount": 0,
    "apiResponse": {
      "date": "2025-08-22",
      "base": "CNY"
    },
    "rateUpdates": [
      {
        "currencyCode": "USD",
        "oldRate": 7.23650000,
        "newRate": 7.17890000,
        "changeAmount": -0.05760000,
        "changePercent": -0.0080,
        "source": "FRANKFURTER_API"
      }
    ],
    "failures": []
  }
}
```

### 3.10 获取汇率历史

#### 接口信息
- **方法**: `GET`
- **路径**: `/api/v1/currencies/rates/history`
- **描述**: 查询汇率变动历史

#### 请求参数
| 参数名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| page | Integer | 否 | 0 | 页码 |
| size | Integer | 否 | 20 | 每页大小 |
| currencyId | String | 否 | - | 币种ID，为空则查询所有 |
| currencyCode | String | 否 | - | 币种代码，为空则查询所有 |
| startDate | Long | 否 | - | 开始日期，毫秒时间戳 |
| endDate | Long | 否 | - | 结束日期，毫秒时间戳 |
| source | String | 否 | - | 汇率来源筛选 |
| sort | String | 否 | effective_date,desc | 排序 |

#### 响应数据
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [
      {
        "id": "rate-001",
        "fromCurrencyCode": "CNY",
        "toCurrencyCode": "USD",
        "toCurrencyName": "美元",
        "rate": 7.17890000,
        "rateType": "SPOT",
        "effectiveDate": 1693190400000,
        "expiryDate": null,
        "source": "FRANKFURTER_API",
        "changeAmount": -0.05760000,
        "changePercent": -0.0080,
        "createdAt": 1693190400000,
        "createdBy": "system"
      }
    ],
    "totalElements": 150,
    "totalPages": 8,
    "number": 0,
    "size": 20
  }
}
```

### 3.11 测试外部API连接

#### 接口信息
- **方法**: `GET`
- **路径**: `/api/v1/currencies/rates/test-connection`
- **描述**: 测试外部汇率API连接状态

#### 请求参数
| 参数名 | 类型 | 必填 | 默认值 | 描述 |
|--------|------|------|--------|------|
| baseCurrency | String | 否 | CNY | 测试用基准币种 |

#### 响应数据
```json
{
  "code": 200,
  "message": "API连接测试完成",
  "data": {
    "connected": true,
    "apiUrl": "https://api.frankfurter.dev/v1/latest",
    "responseTime": 245,
    "lastUpdateDate": "2025-08-22",
    "baseCurrency": "CNY",
    "availableCurrencies": ["USD", "EUR", "GBP", "JPY", "AUD", "CAD"],
    "testResponse": {
      "amount": 1,
      "base": "CNY",
      "date": "2025-08-22",
      "rates": {
        "USD": 0.1393,
        "EUR": 0.12
      }
    },
    "error": null
  }
}
```

### 3.12 获取本位币信息

#### 接口信息
- **方法**: `GET`
- **路径**: `/api/v1/currencies/base`
- **描述**: 获取当前系统的本位币信息

#### 响应数据
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "baseCurrency": {
      "id": "curr-001",
      "code": "CNY",
      "name": "人民币",
      "nameEn": "Chinese Yuan",
      "symbol": "￥",
      "isBase": 1,
      "status": 1
    },
    "lastSyncTime": 1693190400000,
    "nextSyncTime": 1693276800000,
    "totalCurrencies": 5,
    "activeCurrencies": 4
  }
}
```

## 四、DTO设计

### 4.1 请求DTO

```java
// 币种查询DTO
public class CurrencyQueryDTO {
    private Integer page = 0;
    private Integer size = 20;
    private String code;
    private String name;
    private Integer status;
    private Integer isBase;
    private String sort = "created_at,desc";
}

// 币种创建DTO
public class CurrencyCreateDTO {
    private String code;
    private String name;
    private String nameEn;
    private String symbol;
    private Integer decimalPlaces = 2;
    private Integer sortOrder;
}

// 币种更新DTO
public class CurrencyUpdateDTO {
    private String name;
    private String nameEn;
    private String symbol;
    private Integer decimalPlaces;
    private Integer sortOrder;
}

// 汇率更新DTO
public class RateUpdateDTO {
    private BigDecimal rate;
    private Long effectiveDate;
    private String remark;
}

// 汇率同步DTO
public class RateSyncDTO {
    private String baseCurrencyCode;
    private List<String> targetCurrencyCodes;
    private Boolean forceUpdate = false;
}
```

### 4.2 响应DTO

```java
// 币种响应DTO
public class CurrencyDTO {
    private String id;
    private String code;
    private String name;
    private String nameEn;
    private String symbol;
    private Integer isBase;
    private Integer decimalPlaces;
    private Integer status;
    private Integer sortOrder;
    private BigDecimal currentRate;
    private Long lastRateUpdate;
    private Long createdAt;
    private Long updatedAt;
    private String createdBy;
    private String updatedBy;
}

// 汇率历史响应DTO
public class ExchangeRateHistoryDTO {
    private String id;
    private String fromCurrencyCode;
    private String toCurrencyCode;
    private String toCurrencyName;
    private BigDecimal rate;
    private String rateType;
    private Long effectiveDate;
    private Long expiryDate;
    private String source;
    private BigDecimal changeAmount;
    private BigDecimal changePercent;
    private Long createdAt;
    private String createdBy;
}
```

## 五、错误码设计

```java
public enum CurrencyErrorCode {
    // 币种相关错误 (40001-40099)
    CURRENCY_NOT_FOUND(40001, "币种不存在"),
    CURRENCY_CODE_EXISTS(40002, "币种代码已存在"),
    CURRENCY_CODE_INVALID(40003, "币种代码格式无效"),
    CURRENCY_IN_USE(40004, "币种正在使用中，无法删除"),
    
    // 本位币相关错误 (40101-40199)  
    BASE_CURRENCY_REQUIRED(40101, "系统必须设置本位币"),
    BASE_CURRENCY_CANNOT_DELETE(40102, "本位币无法删除"),
    BASE_CURRENCY_ALREADY_EXISTS(40103, "已存在本位币"),
    
    // 汇率相关错误 (40201-40299)
    INVALID_EXCHANGE_RATE(40201, "汇率值无效"),
    RATE_UPDATE_FAILED(40202, "汇率更新失败"),
    EXTERNAL_API_ERROR(40203, "外部汇率API调用失败"),
    RATE_NOT_FOUND(40204, "汇率记录不存在"),
    BASE_CURRENCY_RATE_FIXED(40205, "本位币汇率固定为1，无法修改");
}
```

## 六、权限控制

### 6.1 资源权限码
根据数据库资源表设计，币种汇率模块需要以下权限：

```sql
-- 币种汇率相关权限
INSERT INTO tb_resource VALUES 
('res-0141', ..., 'CURRENCY_VIEW', '查看币种', 'BUTTON', 'res-014', ...),
('res-0142', ..., 'CURRENCY_CREATE', '新增币种', 'BUTTON', 'res-014', ...),
('res-0143', ..., 'CURRENCY_EDIT', '编辑币种', 'BUTTON', 'res-014', ...),
('res-0144', ..., 'CURRENCY_DELETE', '删除币种', 'BUTTON', 'res-014', ...),
('res-0145', ..., 'CURRENCY_SET_BASE', '设置本位币', 'BUTTON', 'res-014', ...),
('res-0146', ..., 'RATE_UPDATE', '更新汇率', 'BUTTON', 'res-014', ...),
('res-0147', ..., 'RATE_SYNC', '同步汇率', 'BUTTON', 'res-014', ...),
('res-0148', ..., 'RATE_HISTORY', '汇率历史', 'BUTTON', 'res-014', ...);
```

### 6.2 权限注解
```java
@PreAuthorize("hasAuthority('CURRENCY_VIEW')")
public ResponsePageDataEntity<CurrencyDTO> getCurrencies(...) {}

@PreAuthorize("hasAuthority('CURRENCY_CREATE')")
public ResponseData<String> createCurrency(...) {}

@PreAuthorize("hasAuthority('RATE_SYNC')")
public ResponseData<RateSyncResult> syncRates(...) {}
```

## 七、实现要点

### 7.1 Repository接口
```java
@Repository
public interface CurrencyRepository extends JpaRepository<Currency, String> {
    
    @Query("SELECT c FROM Currency c WHERE c.deleted = 0 AND c.isBase = 1")
    Optional<Currency> findBaseCurrency();
    
    @Query("SELECT c FROM Currency c WHERE c.deleted = 0 AND c.code = :code")
    Optional<Currency> findByCode(@Param("code") String code);
    
    @Query("SELECT c FROM Currency c WHERE c.deleted = 0 " +
           "AND (:code IS NULL OR c.code LIKE %:code%) " +
           "AND (:name IS NULL OR c.name LIKE %:name%) " +
           "AND (:status IS NULL OR c.status = :status) " +
           "AND (:isBase IS NULL OR c.isBase = :isBase)")
    Page<Currency> findByConditions(@Param("code") String code,
                                   @Param("name") String name,
                                   @Param("status") Integer status,
                                   @Param("isBase") Integer isBase,
                                   Pageable pageable);
}
```

### 7.2 外部API集成服务
```java
@Service
@Slf4j
public class ExternalRateService {
    
    private static final String FRANKFURTER_API = "https://api.frankfurter.dev/v1/latest";
    
    public ExternalRateResponse fetchRates(String baseCurrency, List<String> symbols) {
        // 调用外部API获取汇率
        // 处理响应和异常
        // 返回标准化结果
    }
}
```

### 7.3 缓存策略
使用Spring Boot内置缓存：
```java
@Service
public class CurrencyService {
    
    @Cacheable(value = "currencies", key = "'base'")
    public Currency getBaseCurrency() {
        // 缓存本位币信息
    }
    
    @CacheEvict(value = "currencies", allEntries = true)
    public void setBaseCurrency(String currencyId) {
        // 清除所有币种缓存
    }
}
```

## 八、接口调用时序

1. **页面初始化**：
   - `GET /api/v1/currencies` → 获取币种列表
   - `GET /api/v1/currencies/base` → 获取本位币信息

2. **汇率同步流程**：
   - `GET /api/v1/currencies/rates/test-connection` → 测试API连接
   - `POST /api/v1/currencies/rates/sync` → 执行汇率同步
   - `GET /api/v1/currencies` → 刷新币种列表显示新汇率

3. **汇率历史查询**：
   - `GET /api/v1/currencies/rates/history` → 查询汇率历史

4. **币种管理**：
   - `POST/PUT/DELETE /api/v1/currencies/{id}` → 币种CRUD操作
   - `PUT /api/v1/currencies/{id}/base` → 设置本位币

这份重构版接口文档严格遵循了数据库表结构设计和后端技术约束，确保与现有系统架构的完全兼容。