# 币种汇率模块实现方案

## 一、功能分析

### 1.1 核心功能
通过分析前端界面，币种汇率模块包含以下核心功能：

#### 1.1.1 币种管理
- **新增币种**：添加新的币种信息（代码、名称、符号、汇率）
- **编辑币种**：修改已有币种的信息
- **删除币种**：删除非基准币种
- **状态管理**：启用/停用币种
- **基准币种设置**：设置某个币种为基准币种（汇率固定为1）

#### 1.1.2 汇率管理
- **汇率设置**：手动设置各币种相对于基准币种的汇率
- **汇率更新**：批量更新所有币种的汇率（可对接外部汇率API）
- **实时修改**：在列表中直接修改币种汇率

#### 1.1.3 查询功能
- **币种搜索**：按币种代码、名称、状态进行搜索
- **汇率历史**：查看特定币种或所有币种的汇率变动历史
- **历史查询条件**：按币种、日期范围查询历史记录

#### 1.1.4 数据展示
- **列表展示**：显示所有币种信息
- **基准币种标识**：特殊标记基准币种
- **汇率变动展示**：显示汇率变动幅度和百分比
- **操作记录**：记录汇率更新时间和操作人

### 1.2 业务规则
1. **基准币种规则**
   - 系统必须有且仅有一个基准币种
   - 基准币种的汇率固定为1.0000
   - 基准币种不能被删除
   - 切换基准币种时需要重新计算所有汇率

2. **汇率规则**
   - 汇率精度为小数点后4位
   - 汇率必须大于0
   - 汇率变动需要记录历史

3. **币种代码规则**
   - 币种代码为3位大写字母（遵循ISO 4217标准）
   - 币种代码全局唯一

## 二、数据库设计

### 2.1 币种表（currencies）
```sql
CREATE TABLE currencies (
    id VARCHAR(50) PRIMARY KEY COMMENT '主键ID',
    code VARCHAR(3) NOT NULL UNIQUE COMMENT '币种代码',
    name VARCHAR(50) NOT NULL COMMENT '币种名称',
    symbol VARCHAR(10) NOT NULL COMMENT '币种符号',
    exchange_rate DECIMAL(20,8) NOT NULL DEFAULT 1.00000000 COMMENT '汇率',
    is_base TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否基准币种',
    status VARCHAR(20) NOT NULL DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE-启用，INACTIVE-停用',
    remark TEXT COMMENT '备注',
    
    -- 审计字段
    created_at BIGINT NOT NULL COMMENT '创建时间',
    created_by VARCHAR(50) NOT NULL COMMENT '创建人',
    updated_at BIGINT NOT NULL COMMENT '更新时间',
    updated_by VARCHAR(50) NOT NULL COMMENT '更新人',
    deleted TINYINT(1) NOT NULL DEFAULT 0 COMMENT '删除标记',
    
    INDEX idx_code (code),
    INDEX idx_is_base (is_base),
    INDEX idx_status (status)
) COMMENT='币种表';
```

### 2.2 汇率历史表（currency_rate_history）
```sql
CREATE TABLE currency_rate_history (
    id VARCHAR(50) PRIMARY KEY COMMENT '主键ID',
    currency_id VARCHAR(50) NOT NULL COMMENT '币种ID',
    currency_code VARCHAR(3) NOT NULL COMMENT '币种代码',
    old_rate DECIMAL(20,8) COMMENT '原汇率',
    new_rate DECIMAL(20,8) NOT NULL COMMENT '新汇率',
    change_amount DECIMAL(20,8) COMMENT '变动金额',
    change_percent DECIMAL(10,6) COMMENT '变动百分比',
    update_source VARCHAR(50) COMMENT '更新来源：MANUAL-手动，API-接口，SYSTEM-系统',
    operator VARCHAR(50) NOT NULL COMMENT '操作人',
    
    -- 审计字段
    created_at BIGINT NOT NULL COMMENT '创建时间',
    
    INDEX idx_currency_id (currency_id),
    INDEX idx_currency_code (currency_code),
    INDEX idx_created_at (created_at),
    FOREIGN KEY (currency_id) REFERENCES currencies(id)
) COMMENT='汇率历史表';
```

### 2.3 初始数据
```sql
-- 插入基础币种数据
INSERT INTO currencies (id, code, name, symbol, exchange_rate, is_base, status, created_at, created_by, updated_at, updated_by) VALUES
('CNY', 'CNY', '人民币', '¥', 1.00000000, 1, 'ACTIVE', UNIX_TIMESTAMP()*1000, 'system', UNIX_TIMESTAMP()*1000, 'system'),
('USD', 'USD', '美元', '$', 7.23650000, 0, 'ACTIVE', UNIX_TIMESTAMP()*1000, 'system', UNIX_TIMESTAMP()*1000, 'system'),
('EUR', 'EUR', '欧元', '€', 7.85230000, 0, 'ACTIVE', UNIX_TIMESTAMP()*1000, 'system', UNIX_TIMESTAMP()*1000, 'system'),
('JPY', 'JPY', '日元', '¥', 0.04860000, 0, 'ACTIVE', UNIX_TIMESTAMP()*1000, 'system', UNIX_TIMESTAMP()*1000, 'system'),
('GBP', 'GBP', '英镑', '£', 9.12340000, 0, 'ACTIVE', UNIX_TIMESTAMP()*1000, 'system', UNIX_TIMESTAMP()*1000, 'system');
```

## 三、后端API设计

### 3.1 API端点列表

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | /api/v1/currencies | 获取币种列表（分页、搜索） |
| GET | /api/v1/currencies/{id} | 获取单个币种详情 |
| POST | /api/v1/currencies | 新增币种 |
| PUT | /api/v1/currencies/{id} | 更新币种信息 |
| DELETE | /api/v1/currencies/{id} | 删除币种 |
| PUT | /api/v1/currencies/{id}/status | 更新币种状态 |
| PUT | /api/v1/currencies/{id}/rate | 更新单个币种汇率 |
| POST | /api/v1/currencies/rates/batch | 批量更新汇率 |
| PUT | /api/v1/currencies/{id}/base | 设置基准币种 |
| GET | /api/v1/currencies/rates/history | 获取汇率历史 |
| POST | /api/v1/currencies/rates/sync | 从外部API同步汇率 |

### 3.2 请求/响应示例

#### 3.2.1 获取币种列表
```http
GET /api/v1/currencies?page=0&size=20&code=USD&name=美&status=ACTIVE
```

响应：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "content": [
      {
        "id": "USD",
        "code": "USD",
        "name": "美元",
        "symbol": "$",
        "exchangeRate": 7.2365,
        "isBase": false,
        "status": "ACTIVE",
        "remark": null,
        "updateTime": "2025-08-15 09:00:00"
      }
    ],
    "totalElements": 1,
    "totalPages": 1,
    "number": 0,
    "size": 20
  }
}
```

#### 3.2.2 新增币种
```http
POST /api/v1/currencies
Content-Type: application/json

{
  "code": "HKD",
  "name": "港币",
  "symbol": "HK$",
  "exchangeRate": 0.9245,
  "remark": "香港货币"
}
```

#### 3.2.3 更新汇率
```http
PUT /api/v1/currencies/USD/rate
Content-Type: application/json

{
  "exchangeRate": 7.2500
}
```

#### 3.2.4 获取汇率历史
```http
GET /api/v1/currencies/rates/history?currencyCode=USD&startDate=2025-08-01&endDate=2025-08-15&page=0&size=20
```

## 四、后端实现要点

### 4.1 实体类设计
```java
// Currency.java - 币种实体
@Entity
@Table(name = "currencies")
public class Currency extends BaseEntity {
    @Column(unique = true, length = 3)
    private String code;
    
    private String name;
    private String symbol;
    
    @Column(precision = 20, scale = 8)
    private BigDecimal exchangeRate;
    
    private Boolean isBase;
    private String status;
    private String remark;
}

// CurrencyRateHistory.java - 汇率历史实体
@Entity
@Table(name = "currency_rate_history")
public class CurrencyRateHistory {
    @Id
    private String id;
    
    private String currencyId;
    private String currencyCode;
    
    @Column(precision = 20, scale = 8)
    private BigDecimal oldRate;
    
    @Column(precision = 20, scale = 8)
    private BigDecimal newRate;
    
    @Column(precision = 20, scale = 8)
    private BigDecimal changeAmount;
    
    @Column(precision = 10, scale = 6)
    private BigDecimal changePercent;
    
    private String updateSource;
    private String operator;
    private Long createdAt;
}
```

### 4.2 业务逻辑要点

1. **基准币种切换**
   - 验证新基准币种存在且启用
   - 取消原基准币种标记
   - 设置新基准币种（汇率设为1）
   - 重新计算其他币种汇率（可选）

2. **汇率更新**
   - 记录原汇率
   - 更新新汇率
   - 计算变动金额和百分比
   - 创建历史记录
   - 触发缓存更新

3. **删除币种**
   - 检查是否为基准币种
   - 检查是否有关联的业务数据
   - 逻辑删除而非物理删除

4. **外部API集成**
   - 支持配置外部汇率API
   - 定时任务自动更新
   - 异常处理和重试机制
   - 汇率数据校验

### 4.3 技术要点

1. **缓存策略**
   - 使用Spring Cache缓存币种列表
   - 汇率更新时刷新缓存
   - 考虑使用Redis存储实时汇率

2. **事务处理**
   - 汇率更新和历史记录在同一事务
   - 基准币种切换需要事务保护

3. **精度处理**
   - 使用BigDecimal处理汇率计算
   - 统一汇率精度为8位小数
   - 百分比精度为6位小数

4. **并发控制**
   - 汇率更新使用乐观锁
   - 基准币种切换使用悲观锁

## 五、前端集成要点

### 5.1 API服务封装
```javascript
// api/currency.js
export const currencyApi = {
  // 获取币种列表
  getCurrencies(params) {
    return request.get('/v1/currencies', { params })
  },
  
  // 新增币种
  createCurrency(data) {
    return request.post('/v1/currencies', data)
  },
  
  // 更新汇率
  updateRate(id, rate) {
    return request.put(`/v1/currencies/${id}/rate`, { exchangeRate: rate })
  },
  
  // 设置基准币种
  setBaseCurrency(id) {
    return request.put(`/v1/currencies/${id}/base`)
  },
  
  // 获取汇率历史
  getRateHistory(params) {
    return request.get('/v1/currencies/rates/history', { params })
  }
}
```

### 5.2 实时更新
- 汇率修改后立即调用API
- 使用防抖减少请求频率
- 显示加载状态和错误提示

### 5.3 数据验证
- 币种代码格式验证（3位大写字母）
- 汇率范围验证（大于0）
- 基准币种切换确认

## 六、实现步骤

### 第一阶段：基础功能（2-3天）
1. 创建数据库表和实体类
2. 实现币种CRUD接口
3. 实现汇率更新和历史记录
4. 前端集成基础功能

### 第二阶段：高级功能（1-2天）
1. 实现基准币种切换
2. 添加批量更新功能
3. 实现搜索和筛选
4. 优化用户体验

### 第三阶段：扩展功能（可选）
1. 集成外部汇率API
2. 添加汇率趋势图表
3. 实现汇率预警功能
4. 添加导入导出功能

## 七、注意事项

1. **数据安全**
   - 汇率修改需要权限控制
   - 重要操作需要审计日志
   - 防止汇率被恶意篡改

2. **性能优化**
   - 币种数据量小，可全量缓存
   - 历史记录需要分页和索引
   - 考虑汇率实时性需求

3. **业务扩展**
   - 预留汇率有效期字段
   - 支持买入/卖出汇率
   - 支持汇率浮动范围设置

4. **用户体验**
   - 实时保存汇率修改
   - 清晰的操作反馈
   - 友好的错误提示